<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Royalty Report | Dynotic Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Outfit',sans-serif;}
body{background:#f1f2f7;padding:80px 20px 20px;}
header{position:fixed;top:0;left:0;width:100%;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.1);display:flex;align-items:center;padding:16px 20px;z-index:1000;border-bottom:1px solid #eee;}
header h1{font-size:18px;font-weight:600;}
header #adminName{margin-left:auto;font-size:14px;color:#555;}
form{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:24px;}
form label{font-size:14px;margin-top:12px;display:block;color:#333;}
form input, form select{padding:10px 14px;margin-top:6px;width:100%;border:1px solid #ccc;border-radius:8px;font-size:14px;}
form button{margin-top:16px;padding:10px 16px;background:#111;color:#fff;border:none;border-radius:12px;font-size:14px;cursor:pointer;transition:0.2s;}
form button:hover{filter:brightness(0.9);}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.05);}
thead{background:#f9f9f9;}
th, td{padding:12px;text-align:left;border-bottom:1px solid #eee;font-size:14px;}
th{font-weight:600;}
td button{padding:6px 12px;background:#667eea;color:#fff;border:none;border-radius:8px;font-size:13px;cursor:pointer;transition:0.2s;}
td button:hover{filter:brightness(0.9);}
#adminRoyaltyList tr:nth-child(even){background:#fafafa;}
#adminRoyaltyList td:last-child{text-align:center;}
</style>
</head>
<body>

<header>
  <h1>Admin Royalty Dashboard</h1>
  <span id="adminName">Admin</span>
</header>

<form id="royaltyForm">
  <label>Member</label>
  <select id="memberSelect" required>
    <option value="">-- Pilih Member --</option>
  </select>

  <label>Tanggal</label>
  <input type="date" id="date" required>

  <label>Value</label>
  <input type="number" id="value" placeholder="Value (contoh: 450000)" required>

  <label>Type</label>
  <select id="reportType" required>
    <option value="">-- Pilih Type --</option>
    <option value="Sales Report">Sales Report</option>
    <option value="Payment">Payment</option>
  </select>

  <label>Link Download</label>
  <input type="text" id="downloadUrl" placeholder="Link GitHub/PDF">

  <button type="submit">Add Royalty</button>
</form>

<table>
  <thead>
    <tr>
      <th>Users</th>
      <th>Date</th>
      <th>Value</th>
      <th>Status</th>
      <th>Download</th>
    </tr>
  </thead>
  <tbody id="adminRoyaltyList">
    <tr><td colspan="5" style="text-align:center;color:#777">Memuat data...</td></tr>
  </tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain: "dynopay-2513c.firebaseapp.com",
  databaseURL: "https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = firebase.database();

firebase.auth().onAuthStateChanged(user=>{
  if(!user) window.location.href="../login";
  else {
    document.getElementById("adminName").innerText = user.email;
    loadMembers();
    loadAdminRoyalty();
  }
});

function loadMembers(){
  const sel = document.getElementById("memberSelect");
  db.ref("users").once("value").then(snap=>{
    sel.innerHTML = `<option value="">-- Pilih Member --</option>`;
    const users = snap.val() || {};
    Object.keys(users).forEach(uid=>{
      const u = users[uid];
      sel.innerHTML += `<option value="${uid}" data-email="${u.email}">${u.email} • ${u.nama}</option>`;
    });
  });
}

function downloadFile(url){
  if(url && url.startsWith("http")) window.open(url,"_blank");
  else alert("Link download tidak valid");
}

function loadAdminRoyalty(){
  const list = document.getElementById("adminRoyaltyList");
  list.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">Memuat data...</td></tr>`;

  // preload semua users
  db.ref("users").once("value").then(userSnap=>{
    const users = userSnap.val() || {};

    // mapping email fallback
    const emailMap = {};
    Object.keys(users).forEach(uid=>{ emailMap[users[uid].email] = users[uid]; });

    db.ref("royalties").once("value").then(snap=>{
      if(!snap.exists()){
        list.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">Belum ada data</td></tr>`;
        return;
      }

      const rows = [];
      snap.forEach(item=>{
        const d = item.val();
        // fallback: pakai UID dulu, kalau tidak ada pakai email
        let user = users[d.uid] || {};
        if(!user.email && d.email) user = emailMap[d.email] || {};

        rows.push(`
          <tr>
<td>
  <span style="color:${d.type==='Sales Report'?'green':'blue'};font-weight:600">
    ${d.type}
  </span> • ${user.email || d.email || 'Unknown'} • ${user.nama || ''}
</td>
<td>${d.date}</td>
<td>Rp ${Number(d.value).toLocaleString("id-ID")}</td>
<td>Accepted</td>
<td>${d.downloadUrl ? `<button onclick="downloadFile('${d.downloadUrl}')">Download</button>` : '-'}</td>
          </tr>
        `);
      });

      list.innerHTML = rows.join('');
    });
  });
}

document.getElementById("royaltyForm").addEventListener("submit", function(e){
  e.preventDefault();

  const uid = document.getElementById("memberSelect").value;
  const email = document.getElementById("memberSelect").selectedOptions[0].dataset.email;
  const date = document.getElementById("date").value;
  const type = document.getElementById("reportType").value;
  const value = Number(document.getElementById("value").value);
  const downloadUrl = document.getElementById("downloadUrl").value;

  const newKey = db.ref("royalties").push().key;
  let finalValue = (type==="Payment") ? -Math.abs(value) : value;

  db.ref("royalties/"+newKey).set({uid,email,date,value:finalValue,downloadUrl,type})
    .then(()=>{ loadAdminRoyalty(); this.reset(); })
    .catch(err=>{ console.error("Gagal tambah royalty:",err); });
});
</script>

</body>
</html>
