<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Platform Detail</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:Outfit,sans-serif;
  background:#f1f2f7;
  padding:15px;
}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}
h3{margin-bottom:6px}
.platform{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid #eee;
}
select{
  padding:6px;
  border-radius:6px;
}
button{
  width:100%;
  padding:12px;
  border:none;
  background:#111;
  color:#fff;
  border-radius:8px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="card">
  <h3 id="title">Loading...</h3>
  <small id="artist"></small>
</div>

<div class="card" id="platformWrap"></div>
<div class="card">
  <label for="releaseDate"><b>Release Date</b></label>
  <input type="date" id="releaseDate"
    style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px;">

  <label for="smartlink"><b>Smartlink</b></label>
  <input type="text" id="smartlink"
    placeholder="https://..."
    style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px;">

  <!-- EAN -->
  <label for="ean"><b>EAN Code</b></label>
  <input type="text" id="ean"
    placeholder="Masukkan EAN"
    style="width:100%;padding:8px;border-radius:6px;">
</div>
</div>
<button onclick="savePlatform()">SIMPAN STATUS</button>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
 authDomain:"dynopay-2513c.firebaseapp.com",
 databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth=firebase.auth();
const db=firebase.database();

const params=new URLSearchParams(location.search);
const uid=params.get("uid");
const rid=params.get("rid");

const platforms=[
 "Spotify","Tidal","Amazon","Apple Music",
 "Tiktok","YouTube Music","YouTube Content ID",
 "META","SoundCloud","Tencent"
];

/* ===== SECURITY CHECK ===== */
auth.onAuthStateChanged(user=>{
 if(!user){
   location.href="../admin"; // login admin
   return;
 }

 db.ref("admins/"+user.uid).once("value")
 .then(s=>{
   if(!s.exists()){
     alert("⚠ Bukan admin!");
     auth.signOut().then(()=>location.href="../admin");
   }else{
     loadRelease(); // SAFE
   }
 });
});

/* ===== LOAD RELEASE ===== */
function loadRelease(){
  db.ref(`releases/${uid}/${rid}`).once("value")
  .then(s=>{
    const d = s.val();
    if(!d){ alert("Rilisan tidak ditemukan"); return; }

    document.getElementById("title").innerText = d.title;
    document.getElementById("artist").innerText = d.artist;

    renderPlatform(d.platformStatus || {});

    // ===== Set Release Date & Smartlink =====
    const releaseInput = document.getElementById("releaseDate");
    releaseInput.value = d.date || "";  // kosong kalau belum ada / remix

    const smartlinkInput = document.getElementById("smartlink");
    smartlinkInput.value = d.smartlink || "";
    const eanInput = document.getElementById("ean");
eanInput.value = d.ean || "";
  });
}

/* ===== RENDER ===== */
function renderPlatform(data){
 const wrap=document.getElementById("platformWrap");
 wrap.innerHTML="";

 platforms.forEach(p=>{
   wrap.innerHTML+=`
   <div class="platform">
     <b>${p}</b>
     <select data-name="${p}">
       <option value="process">Process</option>
       <option value="approved">Approved</option>
       <option value="unavailable">Unavailable</option>
     </select>
   </div>`;
 });

 document.querySelectorAll("select").forEach(s=>{
   if(data[s.dataset.name])
     s.value=data[s.dataset.name];
 });
}

/* ===== SAVE ===== */
function savePlatform(){
  // ambil status platform
  let result = {};
  document.querySelectorAll("select").forEach(s=>{
    result[s.dataset.name] = s.value;
  });

  // ambil input release date & smartlink
  const releaseDate = document.getElementById("releaseDate").value;
  const smartlink = document.getElementById("smartlink").value;
  const ean = document.getElementById("ean").value;

const updates = {
  platformStatus: result,
  date: releaseDate || null,
  smartlink: smartlink || null,
  ean: ean || null
};

  db.ref(`releases/${uid}/${rid}`).update(updates)
    .then(()=>alert("✔ Data updated"));
}
</script>
</body>
</html>
