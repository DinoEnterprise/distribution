<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Platform Detail</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:Outfit,sans-serif;
  background:#f1f2f7;
  padding:15px;
}

.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

h3{
  margin-bottom:6px;
}

.platform{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 0;
  border-bottom:1px solid #eee;
}

select{
  padding:6px;
  border-radius:6px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  background:#111;
  color:#fff;
  border-radius:8px;
  font-weight:600;
}

/* ===== INFO GRID ===== */
.info-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
  margin-top:12px;
  font-size:13px;
}

.info-grid div{
  background:#f7f8fc;
  padding:10px;
  border-radius:8px;
}

.info-grid span{
  display:block;
  font-size:11px;
  color:#666;
  margin-bottom:2px;
}

.info-grid b{
  font-size:13px;
  font-weight:600;
}

.info-grid .full{
  grid-column:1 / 3;
}

.info-grid img{
  width:120px;
  border-radius:8px;
  margin-top:6px;
}
</style>
</head>

<body>

<div class="card">
  <h3 id="title">Loading...</h3>
  <small id="artist"></small>
</div>

<div class="card" id="platformWrap"></div>
<div class="card">
  <label for="releaseDate"><b>Release Date</b></label>
  <input type="date" id="releaseDate"
    style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px;">

  <label for="smartlink"><b>Smartlink</b></label>
  <input type="text" id="smartlink"
    placeholder="https://..."
    style="width:100%;padding:8px;border-radius:6px;margin-bottom:10px;">

  <!-- EAN -->
  <label for="ean"><b>EAN Code</b></label>
  <input type="text" id="ean"
    placeholder="Masukkan EAN"
    style="width:100%;padding:8px;border-radius:6px;">
</div>
<button onclick="savePlatform()">SIMPAN STATUS</button>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
 authDomain:"dynopay-2513c.firebaseapp.com",
 databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth=firebase.auth();
const db=firebase.database();

const params=new URLSearchParams(location.search);
const uid=params.get("uid");
const rid=params.get("rid");

const platforms=[
 "Spotify","Tidal","Amazon","Apple Music",
 "Tiktok","YouTube Music","YouTube Content ID",
 "META","SoundCloud","Tencent"
];

/* ===== SECURITY CHECK ===== */
auth.onAuthStateChanged(user=>{
 if(!user){
   location.href="../admin"; // login admin
   return;
 }

 db.ref("admins/"+user.uid).once("value")
 .then(s=>{
   if(!s.exists()){
     alert("⚠ Bukan admin!");
     auth.signOut().then(()=>location.href="../admin");
   }else{
     loadRelease(); // SAFE
   }
 });
});

/* ===== LOAD RELEASE ===== */
function loadRelease(){
  db.ref(`releases/${uid}/${rid}`).once("value")
  .then(s=>{
    const d = s.val();
    if(!d){ alert("Rilisan tidak ditemukan"); return; }

    // Tampilkan data lengkap keterangan
// Tampilkan judul & nama artis tetap di atas
document.getElementById("title").innerText = d.title || "";
document.getElementById("artist").innerText = d.artist || "";

let infoDiv = document.createElement("div");
infoDiv.className = "info-grid";
infoDiv.innerHTML = `
<div><span>Song Title</span><b>${d.title || "-"}</b></div>
<div><span>Version</span><b>${d.version || "-"}</b></div>
<div><span>Genre</span><b>${d.genre || "-"}</b></div>
<div><span>Release Type</span><b>${d.releaseType || "-"}</b></div>
<div><span>Artist</span><b>${d.artist || "-"}</b></div>
<div><span>Full Name</span><b>${d.fullname || "-"}</b></div>
<div><span>Featuring</span><b>${d.featuring || "-"}</b></div>
<div><span>Label</span><b>${d.label || "-"}</b></div>

<div><span>Composer</span><b>${d.composer || "-"}</b></div>
<div><span>Publisher</span><b>${d.publisher || "-"}</b></div>

<div class="full">
  <span>Audio</span>
  ${d.audio ? `<a href="${d.audio}" target="_blank">Preview Audio</a>` : "<i>Kosong</i>"}
</div>

<div class="full">
  <span>Cover</span>
  ${
    d.cover
    ? `
      <a href="${d.cover}" target="_blank">
        <img 
          src="https://drive.google.com/thumbnail?id=${extractDriveId(d.cover)}&sz=w400"
          style="cursor:pointer"
        />
      </a>
    `
    : "<i>Kosong</i>"
  }
</div>
`;

// tambahkan info lengkap di bawah element artist
document.getElementById("artist").insertAdjacentElement("afterend", infoDiv);

    renderPlatform(d.platformStatus || {});

    const releaseInput = document.getElementById("releaseDate");
    releaseInput.value = d.date || "";  // kosong kalau belum ada / remix

    const smartlinkInput = document.getElementById("smartlink");
    smartlinkInput.value = d.smartlink || "";
    const eanInput = document.getElementById("ean");
eanInput.value = d.ean || "";
  });
}

/* ===== RENDER ===== */
function renderPlatform(data){
 const wrap=document.getElementById("platformWrap");
 wrap.innerHTML="";

 platforms.forEach(p=>{
   wrap.innerHTML+=`
   <div class="platform">
     <b>${p}</b>
     <select data-name="${p}">
       <option value="process">Process</option>
       <option value="approved">Approved</option>
       <option value="unavailable">Unavailable</option>
     </select>
   </div>`;
 });

 document.querySelectorAll("select").forEach(s=>{
   if(data[s.dataset.name])
     s.value=data[s.dataset.name];
 });
}
function extractDriveId(url){
  const match = url.match(/\/d\/([^\/]+)/);
  return match ? match[1] : "";
}
function savePlatform(){
  // ambil status platform
  let result = {};
  document.querySelectorAll("select").forEach(s=>{
    result[s.dataset.name] = s.value;
  });

  // ambil input release date & smartlink
  const releaseDate = document.getElementById("releaseDate").value;
  const smartlink = document.getElementById("smartlink").value;
  const ean = document.getElementById("ean").value;

const updates = {
  platformStatus: result,
  date: releaseDate || null,
  smartlink: smartlink || null,
  ean: ean || null
};

  db.ref(`releases/${uid}/${rid}`).update(updates)
    .then(()=>alert("✔ Data updated"));
}
</script>
</body>
</html>
