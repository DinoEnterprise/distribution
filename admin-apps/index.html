<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Users & Apps | Dynotic Admin</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: 'Outfit', sans-serif; background:#f1f2f7; margin:0; padding:15px;}
h3 { font-size:18px; margin-bottom:8px; color:#111;}
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,.05);}
input, select, button { width:100%; padding:12px; margin-top:8px; border-radius:10px; border:1px solid #ddd; font-size:14px; outline:none; box-sizing:border-box;}
input:focus, select:focus { border-color:#111; box-shadow:0 0 6px rgba(0,0,0,.1);}
button { cursor:pointer; transition:.25s; font-weight:600; border-radius:6px; outline:none;}
button.register { background:#111; color:#fff; } 
button.register:hover { opacity:.9; }
button.action-btn { background:#fff; color:#000; border:1px solid #000; font-size:12px; margin-right:4px; padding:6px 10px; }
button.action-btn:hover { background:#f0f0f0; }
.table-container { max-height:500px; overflow:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; min-width:600px; }
th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #eee; }
th { background:#f9f9f9; font-weight:600; }
tr:hover { background:#f5f5f5; }
.status-badge { padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px;}
.menu-wrap { position:relative; display:inline-block; }
.menu-btn { background:none; border:none; font-size:18px; cursor:pointer; }
.menu-dropdown { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; min-width:160px; z-index:99; box-shadow:0 4px 10px rgba(0,0,0,.1); }
.menu-dropdown button { width:100%; border:none; background:none; padding:10px; font-size:13px; text-align:left; }
.menu-dropdown button:hover { background:#f5f5f5; }
#appsModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:999; }
#appsModal .modal-content { background:#fff; padding:20px; border-radius:12px; max-width:400px; width:100%; }
#appsModal h4 { margin-top:0; }
#appsList input { margin-right:8px; }
#appsList label { display:block; margin-bottom:6px; cursor:pointer; }
</style>
</head>
<body>

<div class="card">
  <h3>Users</h3>
  <input id="searchInput" placeholder="Search user..." style="margin-bottom:10px;">
  <div class="table-container">
    <table id="memberTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Apps</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Apps Modal -->
<div id="appsModal">
  <div class="modal-content">
    <h4>Manage Apps for <span id="modalUserName"></span></h4>
    <div id="appsList"></div>
    <button onclick="saveApps()">Save</button>
    <button onclick="closeAppsModal()" style="margin-top:10px;background:#ef4444;color:#fff;">Close</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth = firebase.auth();
const db = firebase.database();

let usersData = {};
let appsData = {};
let currentModalUID = null;

// Auth check
auth.onAuthStateChanged(user => {
  if(!user){ location.href="../admin"; return; }
  db.ref("admins/"+user.uid).once("value").then(snap=>{
    if(!snap.exists()){ alert("⚠ Anda bukan admin!"); auth.signOut().then(()=>location.href="../admin"); }
  });
});

// Load apps & users
function loadApps(){
  db.ref("apps").once("value").then(snap=>{
    appsData = snap.val() || {};
    loadUsers();
  });
}

function loadUsers(){
  db.ref("users").once("value").then(snap=>{
    usersData = snap.val() || {};
    renderUsers(document.getElementById("searchInput").value.toLowerCase());
  });
}

function renderUsers(searchTerm=""){
  const tbody = document.querySelector("#memberTable tbody");
  tbody.innerHTML="";
  for(let uid in usersData){
    const user = usersData[uid];
    if(searchTerm && !user.nama.toLowerCase().includes(searchTerm) && !user.email.toLowerCase().includes(searchTerm)) continue;
    const appsList = Object.keys(user.apps||{}).filter(k=>user.apps[k]);
    const appsLabel = appsList.length ? appsList.join(", ") : "-";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${user.nama}</td>
      <td>${user.email}</td>
      <td>${user.status==="active" ? "<span class='status-badge' style='background:#34d399;color:#fff'>Active</span>" : "<span class='status-badge' style='background:#f87171;color:#fff'>Non-Active</span>"}</td>
      <td>${appsLabel}</td>
      <td>
        <div class="menu-wrap">
          <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
          <div class="menu-dropdown">
            <button onclick="openAppsModal('${uid}')">Manage Apps</button>
            <button onclick="toggleStatus('${uid}')">${user.status==="active"?"Disable":"Activate"}</button>
            <button onclick="deleteUser('${uid}')">Hapus</button>
          </div>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }
}

// Dropdown menu toggle
function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{ if(m!==btn.nextElementSibling) m.style.display="none"; });
  const menu=btn.nextElementSibling;
  menu.style.display=menu.style.display==="block" ? "none" : "block";
}
document.addEventListener("click", e=>{ if(!e.target.closest(".menu-wrap")) document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none"); });

// Status toggle
function toggleStatus(uid){
  const currentStatus = usersData[uid].status;
  const newStatus = currentStatus==="active"?"non-active":"active";
  db.ref(`users/${uid}/status`).set(newStatus).then(()=>{ loadUsers(); });
}

// Delete user
function deleteUser(uid){
  if(confirm("Apakah yakin ingin menghapus user ini?")) db.ref(`users/${uid}`).remove().then(()=>loadUsers());
}

// Manage Apps Modal
function openAppsModal(uid){
  currentModalUID = uid;
  const user = usersData[uid];
  document.getElementById("modalUserName").innerText = user.nama;
  const appsListEl = document.getElementById("appsList");
  appsListEl.innerHTML = "";
  for(let appKey in appsData){
    const checked = user.apps && user.apps[appKey] ? "checked" : "";
    appsListEl.innerHTML += `<label><input type="checkbox" value="${appKey}" ${checked}> ${appsData[appKey].name}</label>`;
  }
  document.getElementById("appsModal").style.display = "flex";
}
function closeAppsModal(){ document.getElementById("appsModal").style.display="none"; currentModalUID=null; }
function saveApps(){
  if(!currentModalUID) return;
  const checkedApps = {};
  document.querySelectorAll("#appsList input:checked").forEach(inp=>{ checkedApps[inp.value]=true; });
  db.ref(`users/${currentModalUID}/apps`).set(checkedApps).then(()=>{
    closeAppsModal();
    loadUsers();
  });
}

// Search input
document.getElementById("searchInput").addEventListener("input", e=>renderUsers(e.target.value.toLowerCase()));

// Initial load
loadApps();
</script>
</body>
</html>
