<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Apps & Users | Dynotic Debug</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family:'Outfit',sans-serif; background:#f1f2f7; margin:0; padding:15px; }
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,.05);}
h3 { font-size:18px; margin-bottom:8px; }
input, button, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
button { cursor:pointer; font-weight:600; }
button.addApp { background:#111; color:#fff; margin-top:4px; }
.status-badge { padding:2px 8px; border-radius:999px; font-size:12px; color:#fff; }
.status-active { background:#34d399; }
.status-nonactive { background:#f87171; }
.menu-wrap { position:relative; display:inline-block; }
.menu-btn { background:none; border:none; font-size:16px; cursor:pointer; }
.menu-dropdown { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; min-width:150px; z-index:99; }
.menu-dropdown button { width:100%; border:none; background:none; padding:8px; text-align:left; font-size:13px; }
.menu-dropdown button:hover { background:#f5f5f5; }
</style>
</head>
<body>

<div class="card">
<h3>All Users</h3>
<input id="searchUser" placeholder="Search user...">
<div style="max-height:400px; overflow-y:auto;">
<table id="userTable" style="width:100%; border-collapse:collapse;">
<thead>
<tr><th>Name</th><th>Email</th><th>Status</th><th>Apps</th><th>Action</th></tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="card">
<h3>Add New App</h3>
<input id="newApp" placeholder="App name...">
<button class="addApp" onclick="addApp()">Add App</button>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();
const auth = firebase.auth();

let appsList = []; // list apps global
let usersData = {}; // cache users

// Load global apps
function loadApps(){
  db.ref("admin-apps").once("value").then(snap=>{
    appsList=[];
    snap.forEach(a=>appsList.push(a.key));
    console.log("Apps loaded:", appsList);
    loadUsers(); // load users after apps
  });
}

// Load users
function loadUsers(){
  const tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML="";
  db.ref("users").once("value").then(snap=>{
    usersData = {};
    snap.forEach(u=>{
      const d = u.val();
      usersData[u.key] = d;
      const statusClass = d.status==="active"?"status-active":"status-nonactive";
      const userApps = d.apps ? Object.keys(d.apps).join(", ") : "(none)";
      
      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${d.nama||"-"}</td>
        <td>${d.email||"-"}</td>
        <td><span class="status-badge ${statusClass}">${d.status}</span></td>
        <td>${userApps}</td>
        <td>
          <div class="menu-wrap">
            <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
            <div class="menu-dropdown">
              <input type="text" placeholder="Search app..." oninput="filterApps(this, '${u.key}')">
              <div id="appButtons-${u.key}" style="max-height:150px;overflow-y:auto;"></div>
            </div>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
      populateAppButtons(u.key);
    });
  });
}

// Dropdown toggle
function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{ if(m!==btn.nextElementSibling)m.style.display="none"; });
  const menu = btn.nextElementSibling;
  menu.style.display = menu.style.display==="block"?"none":"block";
}
document.addEventListener("click",e=>{ if(!e.target.closest(".menu-wrap")) document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none"); });

// Populate apps buttons
function populateAppButtons(uid){
  const container = document.getElementById(`appButtons-${uid}`);
  container.innerHTML="";
  appsList.forEach(app=>{
    const btn = document.createElement("button");
    btn.style.width="100%";
    btn.style.textAlign="left";
    const userApps = usersData[uid].apps||{};
    btn.innerText = `${userApps[app]?"✔ ":""} ${app}`;
    btn.onclick = ()=>toggleUserApp(uid, app);
    container.appendChild(btn);
  });
}

// Toggle app for user
function toggleUserApp(uid, app){
  const userApps = usersData[uid].apps||{};
  const hasApp = !!userApps[app];
  const updates = {};
  updates[`users/${uid}/apps/${app}`] = hasApp ? null : true;
  db.ref().update(updates).then(()=>{
    console.log(`${hasApp?"Removed":"Added"} app "${app}" for user ${uid}`);
    loadApps(); // reload everything
  });
}

// Filter apps in dropdown
function filterApps(input, uid){
  const val = input.value.toLowerCase();
  const container = document.getElementById(`appButtons-${uid}`);
  container.childNodes.forEach(btn=>{
    btn.style.display = btn.innerText.toLowerCase().includes(val)?"block":"none";
  });
}

// Add global app
function addApp(){
  const appName = document.getElementById("newApp").value.trim();
  if(!appName) return alert("App name kosong!");
  db.ref(`admin-apps/${appName}`).set(true).then(()=>{
    document.getElementById("newApp").value="";
    loadApps();
    alert("✔ App added: "+appName);
  });
}

// Search user
document.getElementById("searchUser").addEventListener("input", e=>{
  const term = e.target.value.toLowerCase();
  Array.from(document.querySelectorAll("#userTable tbody tr")).forEach(tr=>{
    const name = tr.cells[0].innerText.toLowerCase();
    const email = tr.cells[1].innerText.toLowerCase();
    tr.style.display = (name.includes(term) || email.includes(term))?"":"none";
  });
});

// Initial load
loadApps();
</script>
</body>
</html>
