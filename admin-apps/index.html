<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Member & Apps | Dynotic Admin</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: 'Outfit', sans-serif; background:#f1f2f7; margin:0; padding:15px;}
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,.05);}
h3 { font-size:18px; margin-bottom:8px;}
table { width:100%; border-collapse:collapse; font-size:13px;}
th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #eee;}
th { background:#f9f9f9; font-weight:600;}
tr:hover { background:#f5f5f5;}
button { cursor:pointer; font-weight:600; border-radius:6px; padding:6px 10px; border:1px solid #000; background:#fff; margin-right:4px; }
button:hover { background:#f0f0f0; }
.menu-wrap { position: relative; display:inline-block; }
.menu-btn { background:none; border:none; font-size:18px; cursor:pointer; }
.menu-dropdown { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; min-width:160px; z-index:99; box-shadow:0 4px 10px rgba(0,0,0,.1);}
.menu-dropdown button { width:100%; border:none; background:none; padding:8px 10px; text-align:left; font-size:13px; }
.menu-dropdown button:hover { background:#f5f5f5; }
input, select { width:100%; padding:8px; margin:4px 0; border-radius:6px; border:1px solid #ddd; outline:none; }
</style>
</head>
<body>

<div class="card">
<h3>Users</h3>
<div class="table-container">
<table id="memberTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Status</th>
      <th>Apps</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>
</div>

<!-- Add App Modal -->
<div id="appModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:300px;">
    <h3>Tambah App untuk User</h3>
    <p id="modalUser"></p>
    <input id="newAppInput" placeholder="App name...">
    <button onclick="addAppToUser()">Tambah</button>
    <button onclick="closeModal()" style="margin-top:10px;">Batal</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

let selectedUser = null;

// Debug fetch users
console.log("=== DEBUG FETCH USERS ===");

// Load all users
function loadMembers(){
  const tbody = document.querySelector("#memberTable tbody");
  tbody.innerHTML = "";
  db.ref("users").once("value").then(snap=>{
    if(!snap.exists()){ console.log("❌ Users kosong!"); return; }
    console.log("✅ Users ditemukan:", snap.numChildren());
    snap.forEach(u=>{
      const d = u.val();
      const apps = d.apps ? Object.keys(d.apps).join(", ") : "-";
      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${d.nama||"-"}</td>
        <td>${d.email||"-"}</td>
        <td>${d.status||"-"}</td>
        <td>${apps}</td>
        <td>
          <div class="menu-wrap">
            <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
            <div class="menu-dropdown">
              <button onclick="openModal('${u.key}','${d.nama||"-"}')">Tambah App</button>
              <button onclick="toggleStatus('${u.key}','${d.status}')">${d.status==='active'?'Disable':'Activate'}</button>
            </div>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });
  }).catch(err=>console.error("❌ Error fetch users:", err));
}

function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{ if(m!==btn.nextElementSibling) m.style.display="none"; });
  const menu=btn.nextElementSibling;
  menu.style.display = menu.style.display==="block"?"none":"block";
}
document.addEventListener("click", e=>{ if(!e.target.closest(".menu-wrap")) document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none"); });

// Toggle status
function toggleStatus(uid,current){
  const newStatus = current==='active'?'non-active':'active';
  db.ref(`users/${uid}/status`).set(newStatus).then(()=>{ alert("Status updated"); loadMembers(); });
}

// Modal functions
function openModal(uid,name){
  selectedUser=uid;
  document.getElementById("modalUser").innerText=name;
  document.getElementById("newAppInput").value="";
  document.getElementById("appModal").style.display="flex";
}
function closeModal(){ selectedUser=null; document.getElementById("appModal").style.display="none"; }

function addAppToUser(){
  const appName = document.getElementById("newAppInput").value.trim();
  if(!selectedUser || !appName) return alert("Masukkan nama app!");
  db.ref(`users/${selectedUser}/apps/${appName}`).set(true).then(()=>{
    alert("✔ App ditambahkan ke user");
    closeModal();
    loadMembers();
  });
}

// Initial load
loadMembers();
</script>
</body>
</html>
