<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apps Manager | Dynotic Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:'Outfit',sans-serif;background:#f1f2f7;margin:0;padding:15px}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,.05)}
h3{margin-bottom:8px}
input,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ddd;font-size:13px}
button{cursor:pointer;font-weight:600;border-radius:6px}
.table-container{max-height:500px;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px 10px;border-bottom:1px solid #eee}
th{background:#f9f9f9}
.status-badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
.menu-wrap{position:relative;display:inline-block}
.menu-btn{background:none;border:none;font-size:18px;cursor:pointer}
.menu-dropdown{display:none;position:absolute;right:0;top:25px;background:#fff;border:1px solid #ddd;border-radius:10px;min-width:230px;z-index:99;box-shadow:0 4px 15px rgba(0,0,0,.1);padding:8px}
.menu-dropdown button{width:100%;border:none;background:none;padding:8px;font-size:13px;text-align:left}
.menu-dropdown button:hover{background:#f5f5f5}
.app-item{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}
</style>
</head>
<body>

<!-- ADD APP -->
<div class="card">
<h3>Add Apps</h3>
<input id="newAppName" placeholder="Nama App Baru">
<button onclick="addApp()">Tambah App</button>
</div>

<!-- LIST APP -->
<div class="card">
<h3>Apps List</h3>
<div id="appsList"></div>
</div>

<!-- USERS -->
<div class="card">
<h3>Users</h3>
<input id="searchInput" placeholder="Search user..." style="margin-bottom:10px;">
<div class="table-container">
<table id="memberTable">
<thead>
<tr>
<th>Name</th>
<th>Email</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSy...",
 authDomain:"dynopay-2513c.firebaseapp.com",
 databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db=firebase.database();
let allApps={};
let searchTerm="";

document.getElementById("searchInput").addEventListener("input",e=>{
 searchTerm=e.target.value.toLowerCase();
 loadMembers();
});

function addApp(){
 const name=document.getElementById("newAppName").value.trim();
 if(!name)return alert("Isi nama app dulu");

 const key=name.toLowerCase().replace(/\s+/g,'');
 db.ref("apps/"+key).set({
   name:name,
   active:true,
   createdAt:Date.now()
 }).then(()=>{
   alert("App berhasil ditambahkan");
   document.getElementById("newAppName").value="";
   loadAppsList();
 });
}

function loadAppsList(){
 const wrap=document.getElementById("appsList");
 wrap.innerHTML="";
 db.ref("apps").once("value",snap=>{
  snap.forEach(app=>{
   const d=app.val();
   const div=document.createElement("div");
   div.style.display="flex";
   div.style.justifyContent="space-between";
   div.innerHTML=`
     <span>${d.name}</span>
     <button onclick="deleteApp('${app.key}')">Hapus</button>
   `;
   wrap.appendChild(div);
  });
 });
}

function deleteApp(key){
 if(confirm("Hapus app ini?")){
  db.ref("apps/"+key).remove().then(loadAppsList);
 }
}

db.ref("apps").on("value",snap=>{
 allApps=snap.val()||{};
});

function loadMembers(){
 const tbody=document.querySelector("#memberTable tbody");
 tbody.innerHTML="";
 db.ref("users").once("value",snap=>{
  snap.forEach(u=>{
   const d=u.val();
   const nama=(d.nama||"").toLowerCase();
   const email=(d.email||"").toLowerCase();
   if(searchTerm && !nama.includes(searchTerm) && !email.includes(searchTerm))return;

   const statusLabel=d.status==="active"
    ?"<span class='status-badge' style='background:#34d399;color:#fff'>Active</span>"
    :"<span class='status-badge' style='background:#f87171;color:#fff'>Non-Active</span>";

   const tr=document.createElement("tr");
   tr.innerHTML=`
    <td>${d.nama}</td>
    <td>${d.email||"-"}</td>
    <td>${statusLabel}</td>
    <td>
     <div class="menu-wrap">
      <button class="menu-btn" onclick="toggleMenu(this)">â‹®</button>
      <div class="menu-dropdown" id="menu-${u.key}">
        <button onclick="toggleStatus('${u.key}','${d.status}')">
          ${d.status==='active'?'Disable':'Activate'}
        </button>
        <button onclick="deleteMember('${u.key}')">Hapus</button>
        <hr>
        <div id="apps-${u.key}"></div>
      </div>
     </div>
    </td>
   `;
   tbody.appendChild(tr);
  });
 });
}

function renderApps(uid){
 const wrap=document.getElementById("apps-"+uid);
 wrap.innerHTML="";
 db.ref("users/"+uid+"/apps").once("value").then(userSnap=>{
  const userApps=userSnap.val()||{};
  Object.keys(allApps).forEach(key=>{
   const checked=userApps[key]?.access===true;
   const div=document.createElement("div");
   div.className="app-item";
   div.innerHTML=`
    <span>${allApps[key].name}</span>
    <input type="checkbox"
      ${checked?"checked":""}
      onchange="setAccess('${uid}','${key}',this.checked)">
   `;
   wrap.appendChild(div);
  });
 });
}

function setAccess(uid,app,val){
 db.ref("users/"+uid+"/apps/"+app).update({access:val});
}

function toggleMenu(btn){
 document.querySelectorAll(".menu-dropdown").forEach(m=>{
  if(m!==btn.nextElementSibling)m.style.display="none";
 });
 const menu=btn.nextElementSibling;
 menu.style.display=menu.style.display==="block"?"none":"block";
 const uid=menu.id.replace("menu-","");
 renderApps(uid);
}

document.addEventListener("click",e=>{
 if(!e.target.closest(".menu-wrap"))
  document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none");
});

function toggleStatus(uid,current){
 const newStatus=current==="active"?"non-active":"active";
 db.ref("users/"+uid+"/status").set(newStatus).then(loadMembers);
}

function deleteMember(uid){
 if(confirm("Hapus user ini?"))
  db.ref("users/"+uid).remove().then(loadMembers);
}

loadAppsList();
loadMembers();
</script>
</body>
</html>
