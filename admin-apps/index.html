<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Users | Dynotic Admin</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: 'Outfit', sans-serif; background:#f1f2f7; margin:0; padding:15px; }
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,.05);}
input, select, button { width:100%; padding:12px; margin-top:8px; border-radius:10px; border:1px solid #ddd; font-size:14px; outline:none; box-sizing:border-box; }
input:focus, select:focus { border-color:#111; box-shadow:0 0 6px rgba(0,0,0,.1); }
button { cursor:pointer; font-weight:600; border-radius:6px; outline:none; transition:.25s;}
button.register { background:#111; color:#fff; }
button.register:hover { opacity:.9; }
button.action-btn { background:#fff; color:#000; border:1px solid #000; font-size:12px; margin-right:4px; padding:6px 10px;}
button.action-btn:hover { background:#f0f0f0; }
.status-badge { padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px; }
.table-container { max-height:500px; overflow-y:auto; overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; min-width:600px; }
th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #eee; }
th { background:#f9f9f9; font-weight:600; }
tr:hover { background:#f5f5f5; }
.menu-wrap { position:relative; display:inline-block; }
.menu-btn { background:none; border:none; font-size:18px; cursor:pointer; }
.menu-dropdown { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; min-width:140px; z-index:99; box-shadow:0 4px 10px rgba(0,0,0,.1);}
.menu-dropdown button { width:100%; border:none; background:none; padding:10px; font-size:13px; text-align:left;}
.menu-dropdown button:hover { background:#f5f5f5; }
#msg {margin-top:6px;font-weight:600;}
</style>
</head>
<body>
<!-- ASSIGN APPS MODAL -->
<div id="appsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); align-items:center; justify-content:center;">
  <div style="background:#fff; width:400px; max-height:500px; border-radius:12px; padding:20px; overflow:hidden; display:flex; flex-direction:column;">
    
    <h3 style="margin-top:0;">Assign Apps</h3>

    <input id="appSearch" placeholder="Search apps..." style="margin-bottom:10px; background:#fff;">

    <div id="appsCheckboxList" style="flex:1; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:8px;"></div>

    <div style="margin-top:15px; display:flex; gap:10px;">
      <button onclick="saveAssignedApps()" class="register">Save</button>
      <button onclick="closeAppsModal()" style="background:#eee;">Cancel</button>
    </div>

  </div> <!-- <-- tutup div modal -->
</div>

<!-- ADD APP -->
<div class="card">
  <h3>Add App</h3>
  <input id="newAppName" placeholder="App Name (gunakan huruf kecil)">
  <button class="register" onclick="addApp()">Add App</button>
  <div id="appMsg"></div>
</div>

<div class="card">
  <h3>Available Apps</h3>
  <ul id="appsList"></ul>
</div>

<!-- USERS TABLE -->
<div class="card">
  <h3>Users</h3>
  <input id="searchInput" placeholder="Search user..." style="margin-bottom:10px;">
  <div class="table-container">
    <table id="memberTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Apps</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth = firebase.auth();
const db = firebase.database();

let searchTerm = "";
document.getElementById("searchInput").addEventListener("input", e=>{
  searchTerm = e.target.value.toLowerCase();
  loadUsers();
});
function loadAppsList(){
  const list = document.getElementById("appsList");
  list.innerHTML = "";
  db.ref("apps").once("value").then(snap=>{
    if(!snap.exists()){ list.innerHTML = "<li>Belum ada apps</li>"; return; }
    Object.keys(snap.val()).forEach(app=>{
      const li = document.createElement("li");
      li.textContent = app;
      list.appendChild(li);
    });
  });
}

// Panggil setiap kali addApp selesai
loadAppsList();
function addApp(){
  const appName = document.getElementById("newAppName").value.trim().toLowerCase();
  const msg = document.getElementById("appMsg");

  if(!appName){
    msg.style.color = "red";
    msg.innerHTML = "⚠ Nama app tidak boleh kosong!";
    return;
  }

  // Simpan ke Firebase di /apps
  db.ref(`apps/${appName}`).set(true)
    .then(()=>{
      msg.style.color = "green";
      msg.innerHTML = "✔ App berhasil ditambahkan!";
      document.getElementById("newAppName").value = "";
    })
    .catch(err=>{
      msg.style.color = "red";
      msg.innerHTML = "❌ " + err.message;
    });
}
function loadUsers(){
  const tbody = document.querySelector("#memberTable tbody");
  tbody.innerHTML = "";
  db.ref("users").once("value").then(snap=>{
    if(!snap.exists()) return;
    snap.forEach(userSnap=>{
      const u = userSnap.val();
      const uid = userSnap.key;
      if(searchTerm && !((u.nama||"").toLowerCase().includes(searchTerm) || (u.email||"").toLowerCase().includes(searchTerm))) return;

      // Tampilkan apps
      let appsList = [];
      if(u.apps) appsList = Object.values(u.apps);
      const appsText = appsList.length ? appsList.join(", ") : "-";

      const statusLabel = u.status==="active" ? "<span class='status-badge' style='background:#34d399;color:#fff'>Active</span>" :
                                               "<span class='status-badge' style='background:#f87171;color:#fff'>Non-Active</span>";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.nama}</td>
        <td>${u.email||"-"}</td>
        <td>${statusLabel}</td>
        <td>${appsText}</td>
        <td>
          <button class="action-btn" onclick="assignApps('${uid}')">Assign Apps</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

let currentAssignUID = null;
let allAppsCache = [];

function assignApps(uid){
  currentAssignUID = uid;
  document.getElementById("appsModal").style.display = "flex";

  db.ref("apps").once("value").then(snap=>{
    if(!snap.exists()){
      document.getElementById("appsCheckboxList").innerHTML = "Belum ada apps";
      return;
    }

    allAppsCache = Object.keys(snap.val());
    renderAppsList(allAppsCache);

    // ambil apps user sekarang
    db.ref(`users/${uid}/apps`).once("value").then(userSnap=>{
      if(userSnap.exists()){
        const userApps = userSnap.val();
        document.querySelectorAll(".app-check").forEach(ch=>{
          if(userApps.includes(ch.value)){
            ch.checked = true;
          }
        });
      }
    });
  });
}

function renderAppsList(apps){
  const box = document.getElementById("appsCheckboxList");
  box.innerHTML = "";

  apps.forEach(app=>{
    const div = document.createElement("div");
    div.style.marginBottom = "6px";
    div.innerHTML = `
      <label style="cursor:pointer;">
        <input type="checkbox" class="app-check" value="${app}"> ${app}
      </label>
    `;
    box.appendChild(div);
  });
}

document.getElementById("appSearch").addEventListener("input", e=>{
  const term = e.target.value.toLowerCase();
  const filtered = allAppsCache.filter(a=>a.toLowerCase().includes(term));
  renderAppsList(filtered);
});

function saveAssignedApps(){
  const selected = [];
  document.querySelectorAll(".app-check:checked").forEach(ch=>{
    selected.push(ch.value);
  });

  db.ref(`users/${currentAssignUID}/apps`).set(selected)
    .then(()=>{
      alert("✔ Apps berhasil diassign");
      closeAppsModal();
      loadUsers();
    });
}

function closeAppsModal(){
  document.getElementById("appsModal").style.display = "none";
  document.getElementById("appSearch").value = "";
}

// Initial load
loadUsers();
</script>
</body>
</html>
