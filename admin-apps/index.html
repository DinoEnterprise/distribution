<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Users & Apps | Dynotic Admin</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: 'Outfit', sans-serif; background:#f1f2f7; margin:0; padding:15px;}
h3 { margin-bottom:8px; font-size:18px; color:#111; }
.card { background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 3px 10px rgba(0,0,0,.05); }
input, button, select { width:100%; padding:10px; margin-top:8px; border-radius:10px; border:1px solid #ddd; font-size:14px; outline:none; box-sizing:border-box; }
button { cursor:pointer; transition:.25s; font-weight:600; border-radius:6px; }
button.add-app { background:#111; color:#fff; }
button.add-app:hover { opacity:.9; }
.table-container { max-height:500px; overflow:auto; }
table { width:100%; border-collapse:collapse; font-size:13px; min-width:600px; }
th, td { padding:8px 10px; text-align:left; border-bottom:1px solid #eee; }
th { background:#f9f9f9; font-weight:600; }
tr:hover { background:#f5f5f5; }
.status-badge { padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px; }
.menu-wrap { position: relative; display: inline-block; }
.menu-btn { background:none; border:none; font-size:18px; cursor:pointer; }
.menu-dropdown { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; min-width:180px; z-index:99; box-shadow:0 4px 10px rgba(0,0,0,.1); padding:10px; }
.menu-dropdown input { margin-bottom:6px; }
.menu-dropdown label { display:block; margin:3px 0; }
.menu-dropdown input[type=checkbox] { margin-right:6px; }
</style>
</head>
<body>

<!-- ADD APP -->
<div class="card">
  <h3>Add App</h3>
  <input id="newApp" placeholder="Nama App Baru">
  <button class="add-app" onclick="addApp()">Add App</button>
</div>

<!-- USERS TABLE -->
<div class="card">
  <h3>Users</h3>
  <input id="searchInput" placeholder="Search user..." style="margin-bottom:10px;">
  <div class="table-container">
    <table id="userTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Apps</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

// Load apps
let appsList = [];
function loadApps(){
  db.ref("apps").once("value").then(snap=>{
    appsList = [];
    snap.forEach(c => appsList.push(c.key));
  });
}
loadApps();

// Add App
function addApp(){
  const name = document.getElementById("newApp").value.trim();
  if(!name) return alert("Nama app wajib diisi!");
  db.ref("apps/"+name).set(true).then(()=>{
    alert("✔ App berhasil ditambahkan");
    document.getElementById("newApp").value="";
    loadApps();
    loadUsers(); // refresh dropdowns
  });
}

// Load users
let searchTerm = "";
document.getElementById("searchInput").addEventListener("input", e=>{
  searchTerm = e.target.value.toLowerCase();
  loadUsers();
});

function loadUsers(){
  const tbody = document.querySelector("#userTable tbody");
  tbody.innerHTML="";
  db.ref("users").once("value").then(snap=>{
    snap.forEach(u=>{
      const d = u.val();
      const nameLower=(d.nama||"").toLowerCase();
      const emailLower=(d.email||"").toLowerCase();
      if(searchTerm && !nameLower.includes(searchTerm) && !emailLower.includes(searchTerm)) return;

      const statusLabel = d.status==="active" ? 
        "<span class='status-badge' style='background:#34d399;color:#fff'>Active</span>" :
        "<span class='status-badge' style='background:#f87171;color:#fff'>Non-Active</span>";

      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${d.nama}</td>
        <td>${d.email||"-"}</td>
        <td>${statusLabel}</td>
        <td>
          <div class="menu-wrap">
            <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
            <div class="menu-dropdown">
              <input type="text" placeholder="Search app..." oninput="filterApps(this)">
              <div id="appList_${u.key}"></div>
            </div>
          </div>
        </td>
      `;
      tbody.appendChild(tr);

      renderAppCheckboxes(u.key, d.apps||{});
    });
  });
}

// Render checkbox list apps
function renderAppCheckboxes(uid, userApps){
  const container = document.getElementById("appList_"+uid);
  container.innerHTML="";
  appsList.forEach(app=>{
    const checked = userApps[app] ? "checked" : "";
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" value="${app}" ${checked} onchange="toggleUserApp('${uid}', '${app}', this.checked)"> ${app}`;
    container.appendChild(label);
  });
}

// Toggle apps untuk user
function toggleUserApp(uid, app, isChecked){
  db.ref(`users/${uid}/apps/${app}`).set(isChecked);
}

// Dropdown toggle
function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{ if(m!==btn.nextElementSibling) m.style.display="none"; });
  const menu = btn.nextElementSibling;
  menu.style.display = menu.style.display==="block" ? "none" : "block";
}
document.addEventListener("click", e=>{
  if(!e.target.closest(".menu-wrap")) document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none");
});

// Filter apps search in dropdown
function filterApps(input){
  const container = input.nextElementSibling;
  const filter = input.value.toLowerCase();
  Array.from(container.children).forEach(label=>{
    label.style.display = label.textContent.toLowerCase().includes(filter) ? "" : "none";
  });
}

// Initial load
loadUsers();
</script>
</body>
</html>
