<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Releases | Dynotic</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Outfit,system-ui;
  background:#f1f2f7;
  padding:14px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:14px;
  box-shadow:0 8px 30px rgba(0,0,0,.06);
}
h3{margin:0 0 12px}

.search{
  margin-bottom:12px;
  position:relative;
}
.search input{
  width:100%;
  padding:10px 12px 10px 36px;
  border-radius:12px;
  border:1px solid #ddd;
}
.search:before{
  content:"üîç";
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  opacity:.6;
}

.table-wrap{overflow-x:auto}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #eee;
}
th{
  background:#fafafa;
  text-align:left;
}
tr:hover{background:#f8f8f8}

.status{
  padding:3px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:700;
  border:1px solid;
}

.action{
  display:flex;
  gap:6px;
  align-items:center;
}
.btn{
  border:1px solid #000;
  background:#fff;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  border-radius:8px;
}
.btn:hover{background:#f2f2f2}

.menu{position:relative}
.menu button{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
}
.menu-box{
  display:none;
  position:absolute;
  right:0;
  background:#fff;
  border-radius:10px;
  border:1px solid #ddd;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
  overflow:hidden;
  z-index:99;
}
.menu-box button{
  width:100%;
  padding:10px;
  border:none;
  background:none;
  text-align:left;
}
.menu-box button:hover{background:#f5f5f5}
.menu-box .danger{color:#ef4444;font-weight:700}

.footer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:12px;
}
</style>
</head>

<body>

<div class="card">
  <h3>Releases</h3>

  <div class="search">
    <input id="search" placeholder="Search email, artist, title">
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Artist</th>
          <th>Title</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="footer">
    <button class="btn" onclick="prev()">Prev</button>
    <b id="pageInfo">Page 1</b>
    <button class="btn" onclick="next()">Next</button>
  </div>
</div>

<script>
// üî• FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth=firebase.auth();
const db=firebase.database();

auth.onAuthStateChanged(u=>{
  if(!u) location.href="../admin";
  else db.ref("admins/"+u.uid).once("value").then(s=>{
    if(!s.exists()){
      alert("Access denied");
      auth.signOut();
    }
  });
});

let DATA=[],page=1;
const perPage=15;
let q="";

document.getElementById("search").oninput=e=>{
  q=e.target.value.toLowerCase();
  page=1;
  render();
};

function load(){
  Promise.all([
    db.ref("users").once("value"),
    db.ref("releases").once("value")
  ]).then(([u,r])=>{
    const email={};
    u.forEach(x=>email[x.key]=x.val().email);

    DATA=[];
    r.forEach(user=>{
      user.forEach(rel=>{
        const d=rel.val();
        DATA.push({
  uid: user.key,
  rid: rel.key,

  // üî• FIX EMAIL
  email: d.email || email[user.key] || "-",

  artist: d.artist || d.artist_name || "-",
  title: d.title || d.track_title || d.release_title || d.name || "-",
  status: d.status || "pending",
  time: d.time || d.createdAt || 0
});
      });
    });

    DATA.sort((a,b)=>b.time-a.time);
    render();
  });
}

function render(){
  const tb=document.getElementById("tbody");
  tb.innerHTML="";

  const f=DATA.filter(d=>{
    return d.email.toLowerCase().includes(q) ||
           d.artist.toLowerCase().includes(q) ||
           d.title.toLowerCase().includes(q);
  });

  const total=Math.ceil(f.length/perPage)||1;
  if(page>total) page=total;

  f.slice((page-1)*perPage,page*perPage).forEach(d=>{
    const c=d.status=="approved"?"#10b981":d.status=="rejected"?"#ef4444":"#f59e0b";
    tb.innerHTML+=`
    <tr>
      <td>${d.email}</td>
      <td>${d.artist}</td>
      <td>${d.title}</td>
      <td><span class="status" style="color:${c};border-color:${c}">${d.status.toUpperCase()}</span></td>
      <td class="action">
        <button class="btn" onclick="location.href='../admin-platform?uid=${d.uid}&rid=${d.rid}'">Detail</button>
        <div class="menu">
          <button onclick="menu(this)">‚ãÆ</button>
          <div class="menu-box">
            <button onclick="setStatus('${d.uid}','${d.rid}','approved')">Approve</button>
            <button onclick="setStatus('${d.uid}','${d.rid}','rejected')">Reject</button>
            <button class="danger" onclick="del('${d.uid}','${d.rid}')">Delete</button>
          </div>
        </div>
      </td>
    </tr>`;
  });

  pageInfo.innerText=`Page ${page} / ${total}`;
}

function next(){page++;render()}
function prev(){if(page>1){page--;render()}}

function setStatus(u,r,s){
  if(confirm("Set status "+s)){
    db.ref(`releases/${u}/${r}/status`).set(s).then(load);
  }
}
function del(u,r){
  if(confirm("Delete release?")){
    db.ref(`releases/${u}/${r}`).remove().then(load);
  }
}

function menu(b){
  document.querySelectorAll(".menu-box").forEach(x=>x.style.display="none");
  b.nextElementSibling.style.display="block";
}
document.onclick=e=>{
  if(!e.target.closest(".menu")){
    document.querySelectorAll(".menu-box").forEach(x=>x.style.display="none");
  }
}

load();
</script>

</body>
</html>
