<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Releases | DynoPay</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  font-family:'Outfit',sans-serif;
  background:#f1f2f7;
  margin:0;
  padding:15px;
}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  box-shadow:0 3px 10px rgba(0,0,0,.05);
}
h3{margin-bottom:10px}

.table-container{overflow-x:auto}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  min-width:700px;
}
th,td{
  padding:8px 10px;
  border-bottom:1px solid #eee;
}
th{background:#f9f9f9}
tr:hover{background:#f5f5f5}

button.action-btn{
  background:#fff;
  border:1px solid #000;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}
button.action-btn:hover{background:#f0f0f0}

.menu-wrap{position:relative;display:inline-block}
.menu-btn{
  background:none;
  border:none;
  font-size:18px;
  cursor:pointer;
}
.menu-dropdown{
  display:none;
  position:absolute;
  right:0;
  background:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  min-width:130px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
  z-index:9;
}
.menu-dropdown button{
  width:100%;
  background:none;
  border:none;
  padding:10px;
  text-align:left;
}
.menu-dropdown button:nth-child(2){
  color:#ef4444;
  font-weight:700;
}
.menu-dropdown button:hover{background:#f5f5f5}

.status{
  padding:2px 8px;
  border-radius:999px;
  font-weight:600;
  font-size:12px;
}
.search-wrap{
  position:relative;
  margin-bottom:10px;
}
.search-wrap input{
  width:100%;
  padding:10px 12px 10px 38px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}
.search-wrap input:focus{
  border-color:#111;
}
.search-wrap::before{
  content:"üîç";
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  font-size:16px;
  opacity:.6;
}
</style>
</head>

<body>

<div class="card">
<h3>Releases</h3>
<div class="search-wrap">
  <input id="searchInput" placeholder="Search email, artist, title...">
</div>
<div class="table-container">
<table id="releaseTable">
<thead>
<tr>
  <th>Email</th>
  <th>Artist</th>
  <th>Title</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
// FIREBASE INIT
firebase.initializeApp({
 apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
 authDomain:"dynopay-2513c.firebaseapp.com",
 databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth = firebase.auth();
const db   = firebase.database();

// ADMIN AUTH CHECK
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="../admin";
    return;
  }

  db.ref("admins/"+user.uid).once("value").then(snap=>{
    if(!snap.exists()){
      alert("‚ö† Access denied");
      auth.signOut().then(()=>location.href="../admin");
    }
  });
});
let searchTerm = "";
document.getElementById("searchInput").addEventListener("input", e=>{
  searchTerm = e.target.value.toLowerCase();
  loadReleases();
});
// LOAD RELEASES
function loadReleases(){
  const tbody=document.querySelector("#releaseTable tbody");
  tbody.innerHTML="";

  Promise.all([
    db.ref("users").once("value"),
    db.ref("releases").once("value")
  ]).then(([uSnap,rSnap])=>{

    let emailMap={};
    uSnap.forEach(u=>{
      emailMap[u.key]=u.val().email;
    });

    let all=[];
    rSnap.forEach(u=>{
      u.forEach(r=>{
        all.push({uid:u.key,rid:r.key,...r.val()});
      });
    });

    all.sort((a,b)=>(b.time||0)-(a.time||0));

    all.forEach(d=>{
  const email  = (emailMap[d.uid]||"").toLowerCase();
  const artist = (d.artist||"").toLowerCase();
  const title  = (d.title||"").toLowerCase();

  // üîç FILTER SEARCH
  if(
    searchTerm &&
    !email.includes(searchTerm) &&
    !artist.includes(searchTerm) &&
    !title.includes(searchTerm)
  ) return;

  const color = getStatusColor(d.status);

  tbody.innerHTML+=`
      <tr>
        <td>${emailMap[d.uid]||"-"}</td>
        <td>${d.artist||"-"}</td>
        <td>${d.title||"-"}</td>
        <td>
          <span class="status" style="border:1px solid ${color};color:${color}">
            ${(d.status||"pending").toUpperCase()}
          </span>
        </td>
        <td style="display:flex;gap:6px;align-items:center">
          <button class="action-btn"
            onclick="location.href='../admin-platform?uid=${d.uid}&rid=${d.rid}'">
            Detail
          </button>

          <div class="menu-wrap">
            <button class="menu-btn" onclick="toggleMenu(this)">‚ãÆ</button>
            <div class="menu-dropdown">
              <button onclick="setStatus('${d.uid}','${d.rid}','approved')">Approve</button>
              <button onclick="setStatus('${d.uid}','${d.rid}','rejected')">Reject</button>
              <button onclick="deleteRelease('${d.uid}','${d.rid}')">Delete</button>
            </div>
          </div>
        </td>
      </tr>`;
    });
  });
}

// ACTIONS
function setStatus(uid,rid,status){
  if(!confirm(`Set status to ${status.toUpperCase()}?`)) return;
  db.ref(`releases/${uid}/${rid}/status`).set(status).then(loadReleases);
}

function deleteRelease(uid,rid){
  if(!confirm("Delete this release?")) return;
  db.ref(`releases/${uid}/${rid}`).remove().then(loadReleases);
}

function getStatusColor(s){
  if(s==="approved") return "#10b981";
  if(s==="rejected") return "#ef4444";
  return "#f59e0b";
}

// MENU
function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{
    if(m!==btn.nextElementSibling) m.style.display="none";
  });
  const m=btn.nextElementSibling;
  m.style.display=m.style.display==="block"?"none":"block";
}
document.addEventListener("click",e=>{
  if(!e.target.closest(".menu-wrap")){
    document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none");
  }
});

loadReleases();
</script>
</body>
</html>
