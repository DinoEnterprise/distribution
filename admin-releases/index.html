<!DOCTYPE html>
<html lang="id">
<head>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
<meta charset="UTF-8">
<title>Admin Panel - DynoPay (Releases)</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: 'Outfit', sans-serif;
  background: #f1f2f7;
  margin: 0;
  padding: 15px;
}
h3 {
  margin-bottom: 8px;
  font-size: 18px;
  color: #111;
}
.card {
  background: #fff;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,.05);
}

button.action-btn {
  background: #fff;
  color: #000;
  border: 1px solid #000;
  font-size: 12px;
  margin-right: 4px;
  padding: 6px 10px;
  cursor: pointer;
}
button.action-btn:hover { background: #f0f0f0; }

.table-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* smooth scroll di mobile */
  max-height: 400px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  min-width: 100%; /* sebelumnya 600px, diganti agar responsive */
}
th, td {
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1px solid #eee;
}
th {
  background: #f9f9f9;
  font-weight: 600;
}
tr:hover {
  background: #f5f5f5;
}

.status-badge {
  padding: 2px 8px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 12px;
}

.menu-wrap {
  position: relative;
  display: inline-block;
}
.menu-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}
.menu-dropdown {
  display: none;
  position: absolute;
  right: 0;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  min-width: 120px;
  z-index: 99;
  box-shadow: 0 4px 10px rgba(0,0,0,.1);
}
.menu-dropdown button {
  width: 100%;
  border: none;
  background: none;
  padding: 12px;
  font-size: 13px;
  text-align: left;
}
.menu-dropdown button:nth-child(2){
  color:#ef4444;
  font-weight:700;
}
.menu-dropdown button:hover {
  background: #f5f5f5;
}
</style>
</head>

<body>

<!-- RELEASES -->
<div class="card">
<h3>Releases</h3>
<input type="text" id="releaseSearch" placeholder="Search song, artist and email" 
       style="width:100%; padding:8px; margin-bottom:8px; border-radius:6px; border:1px solid #ccc;">
<div class="table-container">
<table id="releaseTable">
  <thead>
    <tr>
      <th>Email</th>
      <th>Artist</th>
      <th>Title</th>
      <th>Status</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>
</div>

<script>
let isRegistering = false;
let tempArtists = [];
firebase.initializeApp({
 apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
 authDomain:"dynopay-2513c.firebaseapp.com",
 databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth=firebase.auth();
const db=firebase.database();
const secondaryApp = firebase.initializeApp(
  firebase.app().options,
  "Secondary"
);
const secondaryAuth = secondaryApp.auth();

auth.onAuthStateChanged(user => {
  if(isRegistering) return;

  if (!user) {
    location.href = "../admin";
    return;
  }

  const uid = user.uid;

  db.ref("admins/"+uid).once("value")
  .then(snapshot=>{
    if (!snapshot.exists()) {
      alert("⚠ Anda bukan admin!");
      auth.signOut().then(()=>location.href="../admin");
    }
  })
  .catch(err=>{
    console.error(err);
    auth.signOut().then(()=>location.href="../admin");
  });
});

function confirmRelease(uid, rid, status){
  const text = status === "approved"
    ? "Yakin APPROVE rilis ini?"
    : "⚠ Yakin REJECT rilis ini?\nAksi ini tidak bisa dibatalkan!";

  if(!confirm(text)) return;
  setReleaseStatus(uid, rid, status);
}

function openPlatform(uid,rid){
  location.href = `../admin-platform?uid=${uid}&rid=${rid}`;
}

function setReleaseStatus(uid,rid,status){
  db.ref(`releases/${uid}/${rid}/status`).set(status).then(()=>loadReleases());
}

function deleteRelease(uid,rid){
  if(confirm("Apakah yakin ingin menghapus rilisan ini?")){
    db.ref(`releases/${uid}/${rid}`).remove().then(()=>loadReleases());
  }
}

function getStatusColor(status){
  if(status=="approved") return "#10b981";
  if(status=="rejected") return "#ef4444";
  return "#f59e0b"; // pending
}

function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{
    if(m!==btn.nextElementSibling){
      m.style.display="none";
    }
  });
  const menu = btn.nextElementSibling;
  menu.style.display = menu.style.display==="block" ? "none" : "block";
}

function loadReleases(){
  const tbody = document.querySelector("#releaseTable tbody");
  tbody.innerHTML = "";

  Promise.all([
    db.ref("users").once("value"),
    db.ref("releases").once("value")
  ]).then(([userSnap, releaseSnap])=>{

    let userEmailMap = {};
    userSnap.forEach(u=>{
      userEmailMap[u.key] = u.val().email;
    });

    let all = [];
    releaseSnap.forEach(u=>{
      u.forEach(r=>{
        all.push({
          uid: u.key,
          rid: r.key,
          ...r.val()
        });
      });
    });

    all.sort((a,b)=>(b.time||0)-(a.time||0));

    all.forEach(d=>{
      const email = userEmailMap[d.uid] || "-";

      tbody.innerHTML += `
<tr>
  <td>${email}</td>
  <td>${d.artist || "-"}</td>
  <td>${d.title || "-"}</td>
  <td>
    <span class="status-badge"
      style="border:1px solid ${getStatusColor(d.status)};
      color:${getStatusColor(d.status)}">
      ${(d.status || "pending").toUpperCase()}
    </span>
  </td>
  <td style="display:flex;gap:6px;align-items:center">
    <button class="action-btn" onclick="openPlatform('${d.uid}','${d.rid}')">Detail</button>
    <div class="menu-wrap">
      <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
      <div class="menu-dropdown">
        <button onclick="confirmRelease('${d.uid}','${d.rid}','approved')">Approve</button>
        <button onclick="confirmRelease('${d.uid}','${d.rid}','rejected')">Reject</button>
        <button onclick="deleteRelease('${d.uid}','${d.rid}')">Delete</button>
      </div>
    </div>
  </td>
</tr>
      `;
    });
  });
}
document.getElementById("releaseSearch").addEventListener("input", function() {
  const query = this.value.toLowerCase();

  const rows = document.querySelectorAll("#releaseTable tbody tr");
  rows.forEach(row => {
    const email = row.children[0].innerText.toLowerCase();
    const artist = row.children[1].innerText.toLowerCase();
    const title = row.children[2].innerText.toLowerCase();

    if(email.includes(query) || artist.includes(query) || title.includes(query)) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});
loadReleases();
</script>

</body>
</html>
