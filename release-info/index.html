<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Release | Basic Info</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Outfit", sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea, #764ba2);
      min-height: 100vh;
      padding: 80px 0 40px;
    }

    .wrap {
      width: 92%;
      max-width: 520px;
      margin: auto;
      background: #fff;
      border-radius: 26px;
      padding: 24px;
      box-shadow: 0 25px 45px rgba(0, 0, 0, .18);
    }

    h2 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .sub {
      font-size: 13px;
      color: #666;
      margin-bottom: 22px;
    }

    /* Cover */
    .cover-box {
      width: 100%;
      max-width: 260px;
      height: 260px;
      margin: 0 auto 22px;
      border-radius: 20px;
      border: 2px dashed #d1d5db;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #777;
      font-size: 13px;
      cursor: pointer;
    }

    .cover-box span {
      line-height: 1.6;
    }

    .label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .req {
      color: #ef4444;
    }

    input, select {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #ddd;
      margin-bottom: 16px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, .15);
    }

    /* Artist */
    .artist-box {
      border: 1px dashed #d1d5db;
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 16px;
    }

    .artist-box small {
      font-size: 12px;
      color: #666;
    }

    .create-link {
      display: inline-block;
      margin-top: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #667eea;
      text-decoration: none;
    }

    /* Button */
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 16px;
      font-weight: 700;
      font-size: 15px;
      color: #fff;
      background: linear-gradient(135deg, #667eea, #764ba2);
      cursor: pointer;
    }

    .btn:active {
      transform: scale(.97);
    }

    .plus {
      font-size: 64px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 6px;
      color: #667eea;
    }

    .cover-text {
      font-size: 13px;
      color: #666;
    }
    
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Basic Info</h2>
    <div class="sub">Lengkapi informasi dasar rilisan</div>

    <!-- Cover -->
    <div class="label">Cover Art <span class="req">*</span></div>
    <div class="cover-box">
      <input type="file" id="coverFile" accept="image/png, image/jpeg" style="display:none" onchange="previewCover(this)">
      <img id="coverPreview" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:18px;">
      <div id="coverPlaceholder" onclick="document.getElementById('coverFile').click()">
        <div class="plus">+</div>
        <div class="cover-text">
          Click to upload, must be square 1400-3200px
        </div>
      </div>
    </div>

    <!-- Title -->
    <div class="label">Release Title <span class="req">*</span></div>
    <input type="text" id="releaseTitle" placeholder="Title">

    <!-- Artist -->
    <div class="label">Artist <span class="req">*</span></div>
    <div class="artist-box">
      <div style="position:relative;">
        <input type="text" id="artistName" placeholder="Artist (s)" list="artistList">
        <button id="clearArtist" style="
          position:absolute;
          right:8px;
          top:50%;
          transform:translateY(-50%);
          border:none;
          background:#ef4444;
          color:#fff;
          border-radius:50%;
          width:20px;
          height:20px;
          font-size:14px;
          cursor:pointer;
          display:none;
        ">Ã—</button>
      </div>
      <datalist id="artistList"></datalist>
      <a href="../create-artist" class="create-link">+ Create New Artist</a>
    </div>

    <!-- Release Date -->
    <div class="label">Release Date <span class="req">*</span></div>
    <input type="date" id="releaseDate">
    <small style="font-size:12px;color:#666;">
      Release date must be at least 7 day from now
    </small>
    <br><br>
<!-- Tambahkan spinner di dalam .wrap, di atas tombol Next -->
<div id="loadingSpinner" style="
  display:none;
  text-align:center;
  margin-bottom:16px;
">
  <div style="
    border:4px solid #f3f3f3;
    border-top:4px solid #667eea;
    border-radius:50%;
    width:36px;
    height:36px;
    margin:auto;
    animation: spin 1s linear infinite;
  "></div>
  <div style="font-size:12px;color:#666;margin-top:6px;">Uploading...</div>
</div>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
    <button class="btn" onclick="saveDraft()">Next</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <script>
    // Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
      authDomain: "dynopay-2513c.firebaseapp.com",
      databaseURL: "https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
    });

    const auth = firebase.auth();
    const db = firebase.database();
    

    // Fungsi load artist user ke datalist
    function loadUserArtists() {
      const user = auth.currentUser;
      if (!user) return;

      const datalist = document.getElementById("artistList");
      datalist.innerHTML = "";

      db.ref(`artists/${user.uid}`).once('value').then(snapshot => {
        snapshot.forEach(child => {
          const option = document.createElement("option");
          option.value = child.val().name;  // nama artis
          datalist.appendChild(option);
        });
      });
    }

    // Hapus input artist jika tidak pilih dari list
    document.getElementById("artistName").addEventListener("blur", function() {
      const input = this.value.trim();
      const options = Array.from(document.getElementById("artistList").options).map(o => o.value);

      if (input && !options.includes(input)) {
        this.value = "";
      }
    });

    // Load artist setiap user login
    auth.onAuthStateChanged(user => {
      if (user) {
        loadUserArtists();

        const newArtist = sessionStorage.getItem("newArtist");
        if (newArtist) {
          artistInput.value = newArtist;
          clearBtn.style.display = "block";
          sessionStorage.removeItem("newArtist");
        }
      }
    });

    // Tampilkan tombol X saat ada input
    const artistInput = document.getElementById("artistName");
    const clearBtn = document.getElementById("clearArtist");

    artistInput.addEventListener("input", () => {
      clearBtn.style.display = artistInput.value ? "block" : "none";
    });

    // Clear artist
    clearBtn.addEventListener("click", () => {
      artistInput.value = "";
      clearBtn.style.display = "none";
    });

    // Supabase
    const supabase = supabase.createClient(
      'https://ywlljtnjflomvhxqpsaq.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3bGxqdG5qZmxvbXZoeHFwc2FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzQwMjUsImV4cCI6MjA4NTk1MDAyNX0.obiHDn0oyIL4l2htLDEisKeL9pKAMwhuiGf8wgpIHrQ'
    );

    // Preview cover sebelum upload
    function previewCover(input) {
      const file = input.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = function() {
        if (img.width !== img.height) {
          alert("Cover art harus square!");
          input.value = "";
          return;
        }
        if (img.width < 1400 || img.width > 3200) {
          alert("Width/Height harus antara 1400-3200px!");
          input.value = "";
          return;
        }

        document.getElementById("coverPreview").src = URL.createObjectURL(file);
        document.getElementById("coverPreview").style.display = "block";
        document.getElementById("coverPlaceholder").style.display = "none";
      }
      img.src = URL.createObjectURL(file);
    }

    // Upload cover ke Supabase
    async function uploadCover(file, releaseId) {
      const { data, error } = await supabase.storage
        .from('covers')
        .upload(`release_${releaseId}.png`, file, { upsert: true });

      if (error) throw error;

      const { publicUrl } = supabase.storage.from('covers').getPublicUrl(data.path);
      return publicUrl;
    }

    // Simpan draft ke Firebase
    async function saveDraft() {
  const title = document.getElementById("releaseTitle").value.trim();
  const artist = document.getElementById("artistName").value.trim();
  const date = document.getElementById("releaseDate").value;
  const fileInput = document.getElementById("coverFile");
  const nextBtn = document.querySelector(".btn");
  const spinner = document.getElementById("loadingSpinner");

  if (!title || !artist || !date || fileInput.files.length === 0) {
    alert("Lengkapi semua field wajib termasuk Cover Art");
    return;
  }

  const today = new Date();
  const minDate = new Date(today.getTime() + 7*24*60*60*1000);
  const selectedDate = new Date(date);

  if(selectedDate < minDate){
    alert("Release date minimal 7 hari dari sekarang!");
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    location.href = "../login";
    return;
  }

  // **Tampilkan spinner & disable tombol**
  spinner.style.display = "block";
  nextBtn.disabled = true;

  try {
    const releaseId = "rel_" + Date.now();
    const coverUrl = await uploadCover(fileInput.files[0], releaseId);

    await db.ref(`draftReleases/${user.uid}/${releaseId}`).set({
      releaseId,
      title,
      artist,
      releaseDate: date,
      cover: coverUrl,
      status: "draft",
      createdAt: Date.now()
    });

    window.location.href = `../release-tracklist?rid=${releaseId}`;
  } catch(err) {
    alert("Error saat upload: " + err.message);
    spinner.style.display = "none";
    nextBtn.disabled = false;
  }
}
  </script>
</body>
</html>
