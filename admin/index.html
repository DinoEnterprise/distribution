
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel - DynoPay</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:Outfit,sans-serif;background:#f1f2f7;margin:0;padding:15px}
h3{margin-bottom:8px;font-size:18px}
.card{background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;box-shadow:0 3px 10px rgba(0,0,0,.05)}
input,button{width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid #ddd;font-size:14px}
button{cursor:pointer;font-weight:600}
.register{background:#111;color:#fff}
.action-btn{background:#fff;border:1px solid #000;font-size:12px;padding:6px 10px;margin-right:4px}
.table-container{overflow-x:auto;max-height:400px}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}
th,td{padding:8px 10px;border-bottom:1px solid #eee}
th{background:#f9f9f9}
</style>
</head>

<body>

<div class="card">
<h3>Register Artist</h3>
<input id="email" placeholder="Email">
<input id="password" placeholder="Password">
<input id="nama" placeholder="Nama Artis">
<input id="saldo" placeholder="Saldo awal">
<button class="register" onclick="register()">CREATE ACCOUNT</button>
<p id="msg"></p>
</div>

<div class="card">
<h3>Withdraw Requests</h3>
<div class="table-container">
<table id="withdrawTable">
<thead>
<tr>
<th>Nama</th>
<th>Email</th>
<th>Bank</th>
<th>Rek</th>
<th>Jumlah</th>
<th>Status</th>
<th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div class="card">
<h3>Members</h3>
<div class="table-container">
<table id="memberTable">
<thead>
<tr>
<th>Nama</th>
<th>Email</th>
<th>Saldo</th>
<th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
 authDomain:"dynopay-2513c.firebaseapp.com",
 databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth=firebase.auth();
const db=firebase.database();

/* ADMIN GUARD */
auth.onAuthStateChanged(user=>{
 if(!user){
  location.href="../login";
  return;
 }
 db.ref("admins/"+user.uid).once("value").then(s=>{
  if(!s.exists()){
    alert("Access denied!");
    location.href="../dynopay";
  }
 });
});

/* REGISTER */
function register(){
 let email=emailVal();
 let pass=val("password");
 let nama=val("nama");
 let saldo=Number(val("saldo"));
 const msg=document.getElementById("msg");

 if(!email||!pass||!nama||isNaN(saldo)){
  msg.style.color="red";
  msg.innerHTML="⚠ Semua field wajib!";
  return;
 }

 auth.createUserWithEmailAndPassword(email,pass)
 .then(res=>{
   const uid=res.user.uid;
   db.ref("users/"+uid).set({
     email,nama,saldo,
     createdAt:Date.now()
   });
   msg.style.color="green";
   msg.innerHTML="✔ Akun berhasil dibuat!";
   ["email","password","nama","saldo"].forEach(i=>document.getElementById(i).value="");
 })
 .catch(e=>{
  msg.style.color="red";
  msg.innerHTML=e.message;
 });
}

/* LOAD WITHDRAW */
function loadWithdraws(){
 db.ref("withdraws").on("value",snap=>{
  const tbody=document.querySelector("#withdrawTable tbody");
  tbody.innerHTML="";
  snap.forEach(user=>{
   user.forEach(w=>{
    const d=w.val();
    tbody.innerHTML+=`
    <tr>
     <td>${d.nama}</td>
     <td>${d.email||"-"}</td>
     <td>${d.bank}</td>
     <td>${d.rekening}</td>
     <td>Rp ${Number(d.jumlah).toLocaleString()}</td>
     <td>${d.status}</td>
     <td>
      <button class="action-btn" onclick="approve('${user.key}','${w.key}',${d.jumlah})">Approve</button>
      <button class="action-btn" onclick="setStatus('${user.key}','${w.key}','reject')">Reject</button>
      <button class="action-btn" onclick="delWithdraw('${user.key}','${w.key}')">Delete</button>
     </td>
    </tr>`;
   });
  });
 });
}

/* APPROVE FIX */
function approve(uid,key,amount){
 db.ref(`users/${uid}/saldo`).once("value").then(s=>{
  let current=Number(s.val()||0);
  let sisa=current-Number(amount);
  if(sisa<0) sisa=0;

  db.ref(`users/${uid}/saldo`).set(sisa);
  db.ref(`withdraws/${uid}/${key}/status`).set("approved");
 });
}

function setStatus(uid,key,status){
 db.ref(`withdraws/${uid}/${key}/status`).set(status);
}

function delWithdraw(uid,key){
 if(confirm("Hapus data?")){
  db.ref(`withdraws/${uid}/${key}`).remove();
 }
}

/* MEMBERS */
function loadMembers(){
 db.ref("users").on("value",snap=>{
  const tbody=document.querySelector("#memberTable tbody");
  tbody.innerHTML="";
  snap.forEach(u=>{
   const d=u.val();
   tbody.innerHTML+=`
   <tr>
    <td>${d.nama}</td>
    <td>${d.email||"-"}</td>
    <td>Rp ${(d.saldo||0).toLocaleString()}</td>
    <td>
     <button class="action-btn" onclick="editSaldo('${u.key}')">Edit</button>
     <button class="action-btn" onclick="delMember('${u.key}')">Hapus</button>
    </td>
   </tr>`;
  });
 });
}

function editSaldo(uid){
 let v=prompt("Saldo baru:");
 if(v!==null){
  v=Number(v);
  if(isNaN(v)) return alert("Harus angka!");
  db.ref("users/"+uid+"/saldo").set(v);
 }
}

function delMember(uid){
 if(confirm("Hapus member?")){
  db.ref("users/"+uid).remove();
 }
}

function val(id){return document.getElementById(id).value.trim()}
function emailVal(){return document.getElementById("email").value.trim()}

loadWithdraws();
loadMembers();
</script>

</body>
</html>
