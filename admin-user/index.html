<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Users & Apps | Dynotic Admin</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: 'Outfit', sans-serif; background: #f1f2f7; margin: 0; padding: 15px;}
h3 { margin-bottom: 8px; font-size: 18px; color: #111; }
.card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 3px 10px rgba(0,0,0,.05);}
input, select, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; outline:none; box-sizing:border-box;}
input:focus, select:focus { border-color:#111; box-shadow:0 0 6px rgba(0,0,0,.1); }
button { cursor:pointer; transition:0.25s; font-weight:600; border-radius:6px; outline:none; }
button.register { background:#111; color:#fff; }
button.register:hover { opacity:0.9; }
button.action-btn { background:#fff;color:#000;border:1px solid #000;font-size:12px;margin-right:4px;padding:6px 10px; }
button.action-btn:hover { background:#f0f0f0; }

.table-container { max-height: 500px; overflow-y:auto; overflow-x:auto;}
table { width:100%; border-collapse: collapse; font-size:13px; min-width:600px;}
th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #eee;}
th { background:#f9f9f9; font-weight:600; }
tr:hover { background:#f5f5f5; }

.status-badge { padding:2px 8px; border-radius:999px; font-weight:600; font-size:12px; }
#msg { margin-top:6px;font-weight:600; }

.menu-wrap { position: relative; display: inline-block; }
.menu-btn { background: none; border:none; font-size:18px; cursor:pointer; }
.menu-dropdown { display:none; position:absolute; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; min-width:180px; z-index:99; box-shadow:0 4px 10px rgba(0,0,0,.1);}
.menu-dropdown button { width:100%; border:none; background:none; padding:8px; font-size:13px; text-align:left;}
.menu-dropdown button:hover { background:#f5f5f5; }

/* Modal apps */
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.4);}
.modal-content { background:#fff; margin:10% auto; padding:20px; border-radius:12px; max-width:400px; position:relative;}
.modal h4 { margin-top:0;}
.modal input { margin-bottom:6px;}
.close-modal { position:absolute; right:10px; top:10px; font-size:18px; cursor:pointer; border:none; background:none; }
.app-list { max-height:200px; overflow:auto; border:1px solid #ddd; border-radius:8px; padding:6px; }
.app-list label { display:flex; justify-content:space-between; padding:4px; cursor:pointer; }
</style>
</head>
<body>

<!-- ADD APP -->
<div class="card">
  <h3>Add App</h3>
  <input id="newAppName" placeholder="App Name">
  <button class="register" onclick="addApp()">Add App</button>
  <div id="appMsg"></div>
</div>

<!-- USERS TABLE -->
<div class="card">
  <h3>Users</h3>
  <input id="searchInput" placeholder="Search user..." style="margin-bottom:10px;">
  <div class="table-container">
    <table id="memberTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Apps Access</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- MODAL APPS -->
<div class="modal" id="appsModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeModal()">✖</button>
    <h4>Manage Apps Access</h4>
    <input id="appSearchInput" placeholder="Search apps...">
    <div class="app-list" id="appList"></div>
    <button class="register" onclick="saveApps()">Save</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = firebase.database();
let usersData = {};
let appsData = {};
let currentUid = "";

// Load apps
function loadApps(){
  db.ref("apps").once("value").then(snap=>{
    appsData = snap.val() || {};
    renderUsers();
  });
}

// Add app
function addApp(){
  const name = document.getElementById("newAppName").value.trim();
  const msg = document.getElementById("appMsg");
  if(!name){ msg.style.color="red"; msg.innerText="⚠ Nama app wajib diisi"; return; }
  const appKey = name.toLowerCase().replace(/\s+/g,'_');
  db.ref("apps/"+appKey).set({ name }).then(()=>{
    msg.style.color="green"; msg.innerText="✔ App berhasil ditambahkan";
    document.getElementById("newAppName").value="";
    loadApps();
  });
}

// Load users
function loadUsers(){
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  db.ref("users").once("value").then(snap=>{
    usersData = snap.val() || {};
    renderUsers(searchTerm);
  });
}

// Render users
function renderUsers(searchTerm=""){
  const tbody = document.querySelector("#memberTable tbody");
  tbody.innerHTML="";
  for(let uid in usersData){
    const user = usersData[uid];
    if(searchTerm && !user.nama.toLowerCase().includes(searchTerm) && !user.email.toLowerCase().includes(searchTerm)) continue;
    const appsList = Object.keys(user.apps||[]).filter(k=>user.apps[k]);
    const appsLabel = appsList.length ? appsList.join(", ") : "-";
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${user.nama}</td>
      <td>${user.email}</td>
      <td>${user.status==="active" ? "<span class='status-badge' style='background:#34d399;color:#fff'>Active</span>" : "<span class='status-badge' style='background:#f87171;color:#fff'>Non-Active</span>"}</td>
      <td>${appsLabel}</td>
      <td>
        <div class="menu-wrap">
          <button class="menu-btn" onclick="toggleMenu(this)">⋮</button>
          <div class="menu-dropdown">
            <button onclick="openAppsModal('${uid}')">Manage Apps</button>
            <button onclick="toggleStatus('${uid}')">${user.status==="active"?"Disable":"Activate"}</button>
            <button onclick="deleteUser('${uid}')">Hapus</button>
          </div>
        </div>
      </td>`;
    tbody.appendChild(tr);
  }
}

// Dropdown menu toggle
function toggleMenu(btn){
  document.querySelectorAll(".menu-dropdown").forEach(m=>{ if(m!==btn.nextElementSibling) m.style.display="none"; });
  const menu = btn.nextElementSibling;
  menu.style.display = menu.style.display==="block" ? "none" : "block";
}
document.addEventListener("click", e=>{ if(!e.target.closest(".menu-wrap")) document.querySelectorAll(".menu-dropdown").forEach(m=>m.style.display="none"); });

// Manage apps modal
function openAppsModal(uid){
  currentUid = uid;
  const modal = document.getElementById("appsModal");
  modal.style.display="block";
  renderAppList();
}
function closeModal(){ document.getElementById("appsModal").style.display="none"; }

// Render apps checkbox
function renderAppList(){
  const container = document.getElementById("appList");
  const search = document.getElementById("appSearchInput").value.toLowerCase();
  container.innerHTML="";
  for(let key in appsData){
    if(search && !appsData[key].name.toLowerCase().includes(search)) continue;
    const userApps = usersData[currentUid].apps||{};
    const checked = userApps[key] ? "checked" : "";
    const label = document.createElement("label");
    label.innerHTML=`<span>${appsData[key].name}</span><input type="checkbox" data-key="${key}" ${checked}>`;
    container.appendChild(label);
  }
}

// Save apps
function saveApps(){
  const container = document.getElementById("appList");
  const checkboxes = container.querySelectorAll("input[type=checkbox]");
  const updates = {};
  checkboxes.forEach(cb=>{
    updates[cb.dataset.key] = cb.checked;
  });
  db.ref("users/"+currentUid+"/apps").set(updates).then(()=>{
    alert("✔ Apps access updated");
    loadUsers();
    closeModal();
  });
}

// Toggle status
function toggleStatus(uid){
  const current = usersData[uid].status;
  const newStatus = current==="active" ? "non-active" : "active";
  db.ref("users/"+uid+"/status").set(newStatus).then(()=>{ loadUsers(); });
}

// Delete user
function deleteUser(uid){
  if(confirm("Apakah yakin ingin menghapus user ini?")) db.ref("users/"+uid).remove().then(()=>loadUsers());
}

// App search input
document.getElementById("appSearchInput").addEventListener("input", renderAppList);
document.getElementById("searchInput").addEventListener("input", loadUsers);

// Initial load
loadApps();
loadUsers();
</script>

</body>
</html>
