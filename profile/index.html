<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - DynoPay</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Outfit",sans-serif;}
body{background:#f1f2f7;min-height:100vh;color:#111;animation:fadeIn .5s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
header{padding:12px 20px;display:flex;align-items:center;background:white;border-bottom:1px solid #eee;}
header img{height:50px;}
.card{width:90%;margin:25px auto;background:#fff;border-radius:20px;padding:25px;border:1px solid #ececec;box-shadow:0 8px 18px rgba(0,0,0,.05);}
.card-title{font-size:16px;font-weight:600;opacity:.8;margin-bottom:12px;}
.input-group{margin-bottom:15px;}
.input-group label{display:block;font-size:13px;margin-bottom:4px;opacity:.8;}
.input-group input{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;font-size:14px;outline:none;background:#f9f9f9;}
.input-group input:focus{border-color:#111;background:#fff;}
.profile-photo{width:120px;height:120px;border-radius:50%;object-fit:cover;cursor:pointer;border:2px solid #ddd;margin-bottom:12px;}
button.save-btn{width:100%;padding:12px;background:#111;color:#fff;border:none;border-radius:10px;font-weight:600;cursor:pointer;margin-top:12px;}
button.save-btn:hover{opacity:.9;}
.bottom-nav{background:#fff;border-top:1px solid #eee;padding:10px 0;display:flex;justify-content:space-around;align-items:center;position:fixed;bottom:0;left:0;width:100%;}
.nav-item{text-align:center;font-size:13px;opacity:.75;cursor:pointer;padding:4px 14px;border-radius:12px;transition:.25s;}
.nav-item img{width:28px;display:block;margin:auto;margin-bottom:4px;border-radius:50%;}
.nav-item:active{background:#e9ebf3;transform:scale(.95);}
</style>
</head>
<body>
<header>
  <img src="../assets/dynopay2.png" alt="DynoPay">
</header>

<!-- FOTO PROFIL -->
<div class="card" style="text-align:center;">
  <img id="profilePhoto" class="profile-photo" src="../assets/profile.png" alt="Profile Photo" title="Klik untuk ganti foto">
  <input type="file" id="photoInput" style="display:none;">
</div>

<!-- INFO ARTIS -->
<div class="card">
  <div class="card-title">Nama Artis</div>
  <div class="input-group">
    <input type="text" id="nama" readonly>
  </div>
  <div class="card-title">Email</div>
  <div class="input-group">
    <input type="text" id="email" readonly>
  </div>
  <div class="card-title">Label</div>
  <div class="input-group">
    <input type="text" id="label" readonly value="Dynotic">
  </div>
  <button class="save-btn" onclick="saveProfile()">Simpan Profile</button>
</div>

<!-- NAV BAWAH -->
<div class="bottom-nav">
  <div class="nav-item" onclick="goDashboard()">
    <img src="../assets/dasboard.png" alt="Dashboard">
    Dashboard
  </div>
  <div class="nav-item" onclick="goWithdraw()">
    <img src="../assets/withdraw.png" alt="Withdraw">
    Withdraw
  </div>
  <div class="nav-item" onclick="goProfile()">
    <img id="navProfile" src="../assets/profile.png" alt="Profile">
    Profile
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
  authDomain:"dynopay-2513c.firebaseapp.com",
  databaseURL:"https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app",
  storageBucket:"dynopay-2513c.appspot.com"
});

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();
let selectedFile = null;

// Proteksi login
auth.onAuthStateChanged(user=>{
  if(!user) window.location.href="../login";
  else loadProfile(user.uid);
});

// Load profile
function loadProfile(uid){
  db.ref("users/"+uid).once("value").then(snap=>{
    if(snap.exists()){
      const data = snap.val();
      document.getElementById("nama").value = data.nama || "";
      document.getElementById("email").value = data.email || "";
      document.getElementById("profilePhoto").src = data.photoURL || "../assets/profile.png";
      document.getElementById("navProfile").src = data.photoURL || "../assets/profile.png";
    }
  });
}

// Klik foto untuk ganti
document.getElementById("profilePhoto").addEventListener("click", ()=>{
  document.getElementById("photoInput").click();
});

document.getElementById("photoInput").addEventListener("change", e=>{
  selectedFile = e.target.files[0];
  if(selectedFile){
    const reader = new FileReader();
    reader.onload = function(ev){
      document.getElementById("profilePhoto").src = ev.target.result;
    }
    reader.readAsDataURL(selectedFile);
  }
});

// Simpan profile (upload foto)
function saveProfile(){
  if(!selectedFile){
    alert("⚠ Tidak ada foto yang dipilih!");
    return;
  }
  const user = auth.currentUser;
  const ext = selectedFile.name.split('.').pop();
  const storageRef = storage.ref("profilePhotos/"+user.uid+"."+ext);

  storageRef.put(selectedFile).then(() => storageRef.getDownloadURL())
  .then(url => {
    // tambahkan timestamp supaya browser refresh gambar
    const newUrl = url + "?t=" + Date.now();
    db.ref("users/"+user.uid+"/photoURL").set(url)
    .then(()=>{
      document.getElementById("profilePhoto").src = newUrl; // update foto utama
      document.getElementById("navProfile").src = newUrl;    // update icon bawah
      alert("✔ Profile berhasil disimpan!");
      selectedFile = null;
    });
  })
  .catch(err=>{
    alert("⚠ "+err.message);
  });
}

// Navigasi
function goDashboard(){ window.location.href="../dynopay"; }
function goWithdraw(){ window.location.href="../withdraw"; }
function goProfile(){ window.location.href="../profile"; }
</script>
</body>
</html>
