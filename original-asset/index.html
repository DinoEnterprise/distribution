<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Origianal Asset | Dynotic Distribution</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* RESET & BODY */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Outfit", sans-serif;
    }

    body {
      background: linear-gradient(135deg,#667eea,#764ba2);
      min-height: 100vh;
      padding-top: 72px;
    }

    /* HEADER */
    header {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-bottom: 1px solid #eee;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 9999;
      transition: box-shadow 0.3s;
    }

    header img {
      height: 42px;
    }

    header.scrolled {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* WRAPPER */
    .wrap {
      width: 92%;
      margin: 18px auto;
      background: rgba(255,255,255,0.95);
      border-radius: 24px;
      padding: 22px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.18);
      animation: fade 0.4s ease;
    }

    @keyframes fade {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; }
    }

    /* STEP PROGRESS */
    .steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      position: relative;
    }

    .steps::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 5%;
      right: 5%;
      height: 3px;
      background: #e5e7eb;
      z-index: 0;
    }

    .step {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #666;
      z-index: 1;
    }

    .step.active {
      background: linear-gradient(135deg,#667eea,#764ba2);
      color: #fff;
      box-shadow: 0 6px 18px rgba(102,126,234,0.5);
    }

    /* FORM */
    .section {
      animation: fade 0.4s;
    }

    .label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .req { color: red; }

    input, select {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #ddd;
      margin-bottom: 16px;
      font-size: 14px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.15);
    }

    /* BUTTON */
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 16px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg,#667eea,#764ba2);
      cursor: pointer;
    }

    .btn.gray {
      background: #e5e7eb;
      color: #111;
    }

    .btn:active { transform: scale(0.96); }

    /* PREVIEW */
    .preview {
      background: #f9fafb;
      border-radius: 16px;
      padding: 16px;
      font-size: 14px;
      line-height: 1.7;
    }

    .preview div { margin-bottom: 8px; }
    .preview span { color: #667eea; font-weight: 600; }
  </style>
</head>

<body>
  <header id="mainHeader">
    <img src="../assets/dynotic-distribution.png" alt="DynoPay Logo">
  </header>

  <div class="wrap">
    <!-- STEP PROGRESS -->
    <div class="steps">
      <div class="step active" id="s1">1</div>
      <div class="step" id="s2">2</div>
      <div class="step" id="s3">3</div>
      <div class="step" id="s4">4</div>
    </div>

    <!-- STEP 1 -->
    <div id="step1" class="section">
      <div class="label">Type Asset <span class="req">*</span></div>
    <select id="type" hidden>
  <option value="original" selected>Original Asset</option>
</select>
      <button type="button" class="btn" onclick="next(1)">Continue</button>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="section" hidden></div>

<!-- STEP 3 -->
<div id="step3" class="section" hidden>
  <div class="label">Audio File *</div>
  <input id="audio" type="file" accept="audio/*">
  <progress id="audioProgress" value="0" max="100" style="width:100%; display:none;"></progress>

  <div class="label">Cover Art *</div>
  <input id="cover" type="file" accept="image/*">
  <progress id="coverProgress" value="0" max="100" style="width:100%; display:none;"></progress>

  <button type="button" class="btn gray" onclick="back(3)">Back</button>
  <br><br>
<button type="button" class="btn" id="previewBtn" onclick="loadPreview(); goto(4)" disabled>Preview</button>
</div>

<!-- STEP 4 -->
<div id="step4" class="section" hidden>
      <div class="preview" id="previewBox"></div>
      <br>
      <button class="btn gray" onclick="back(4)">Edit</button>
      <br><br>
      <button class="btn" id="submitBtn" onclick="submitRelease()">
        <span id="btnText">Submit Release</span>
        <span id="btnLoader" style="display:none;">Loading...</span>
      </button>
    </div>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ====== Firebase Initialization ======
    firebase.initializeApp({
      apiKey: "AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
      authDomain: "dynopay-2513c.firebaseapp.com",
      databaseURL: "https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
    });

    const db = firebase.database();
const WORKER_URL = "https://upload-assets.dynotic-bot.workers.dev/"; // ganti sesuai worker mu

async function uploadFile(file, progressEl, callback){
  const formData = new FormData();
  formData.append("file", file);

  progressEl.style.display = "block";
  progressEl.value = 0;

  try {
    // Simulasi progress (jika worker tidak kirim progress)
    let fakeProgress = 0;
    const interval = setInterval(()=>{
      if(fakeProgress < 90) { fakeProgress += 5; progressEl.value = fakeProgress; }
    }, 100);

    const res = await fetch(WORKER_URL, { method: "POST", body: formData });
    clearInterval(interval);
    progressEl.value = 100;

    const data = await res.json();
    if(data.success) callback(data.url);
    else { alert("Upload gagal: " + data.error); callback(null); }

  } catch(e){
    progressEl.value = 0;
    alert("Upload gagal: " + e.message);
    callback(null);
  }
}
    // Redirect if not logged in
    firebase.auth().onAuthStateChanged(user => {
      if (!user) location.href = "../login";
    });

    // ====== STEP LOGIC ======
    const stepsData = {
      1: () => true,
      2: () => {
        if(type.value === "original"){
          return document.getElementById("title")?.value &&
                 document.getElementById("artist")?.value &&
                 document.getElementById("genre")?.value &&
                 document.getElementById("releaseType")?.value &&
                 document.getElementById("fullname")?.value &&
                 document.getElementById("label")?.value &&
                 document.getElementById("release")?.value;
        }
        if(type.value === "cover"){
          return document.getElementById("title")?.value &&
                 document.getElementById("artist")?.value &&
                 document.getElementById("genre")?.value &&
                 document.getElementById("publisher")?.value &&
                 document.getElementById("composer")?.value;
        }
      },
      3: () => document.getElementById("audio")?.dataset.url &&
       document.getElementById("cover")?.dataset.url
    };

    // STEP NAVIGATION
    function hideAll() {
      for(let i=1; i<=4; i++) document.getElementById("step"+i).hidden = true;
    }
let listenersAttached = false;


let audioUploaded = false;
let coverUploaded = false;

function attachUploadListeners(){
  if(listenersAttached) return;
  listenersAttached = true;

  const audioInput = document.getElementById("audio");
 audioInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  audioUploaded = false;

  uploadFile(file, document.getElementById("audioProgress"), url => {
    if(url){
      audioInput.dataset.url = url;
      audioUploaded = true;
      checkAllUploaded();
    }
  });
}); 
  const coverInput = document.getElementById("cover");
  const previewBtn = document.getElementById("previewBtn");
  if(!audioInput || !coverInput || !previewBtn) return;

  previewBtn.disabled = true; // tombol Preview disable awal

  coverInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;
  coverUploaded = false;

  // Preview cover
  const preview = document.getElementById("coverPreview");
  const reader = new FileReader();
  reader.onload = ev => {
    if(preview){
      preview.src = ev.target.result;
      preview.style.display = "block";
    }
  };
  reader.readAsDataURL(file);

  uploadFile(file, document.getElementById("coverProgress"), url => {
    if(url){
      coverInput.dataset.url = url;
      coverUploaded = true;
      checkAllUploaded();
    }
  });
});


// Enable Preview button otomatis saat kedua file selesai
function checkAllUploaded(){
  const previewBtn = document.getElementById("previewBtn");
  if(previewBtn) previewBtn.disabled = !(audioUploaded && coverUploaded);
}

// Modifikasi next() untuk step 3
function next(n) {
  if(n === 1 && !stepsData[1]()) return alert("Type wajib");
  if(n === 1) loadStep2Fields();
  if(n === 2 && !stepsData[2]()) return alert("Lengkapi master");

  if(n === 3){
    attachUploadListeners();
    // Validasi upload selesai
    if(!audioUploaded || !coverUploaded){
      return alert("Tunggu sampai audio dan cover selesai di-upload!");
    }
    // ---- Tambahkan ini ----
    loadPreview(); // generate isi preview sebelum tampil Step 4
  }

  goto(n+1); // pindah ke step berikutnya
}

    function back(n) { goto(n-1); }

    // Clickable step headers
    s1.onclick = () => goto(1);
    s2.onclick = () => goto(2);
    s3.onclick = () => goto(3);
    s4.onclick = () => goto(4);

    // ====== LOAD STEP 2 FIELDS ======
    function loadStep2Fields() {
      const s = document.getElementById("step2");
      s.innerHTML = "";

      if(type.value === "original") {
    s.innerHTML += `
      <div class="label">Cover Art *</div>
      <input id="cover" type="file" accept="image/*">
      <img id="coverPreview" style="width:120px;margin:6px 0;display:none;">

      <div class="label">Song Title *</div><input id="title">
      <div class="label">Version</div>
      <small style="font-size:11px;color:#777;">Contoh: Remix, Remastered, Live, dll</small>
      <input id="version" placeholder="Optional">
      <div class="label">Genre *</div>
      <select id="genre">
        <option value="">Select</option>
        <option>Blues</option><option>Dangdut</option><option>Electronic</option>
        <option>Hip-hop</option><option>Instrumental</option><option>Jazz</option>
        <option>Metal</option><option>Pop</option><option>R&B</option>
        <option>Reggae</option><option>Rock</option>
      </select>
      <div class="label">Release Type *</div>
      <select id="releaseType">
        <option value="">Pilih</option>
        <option>Single</option>
        <option>EP</option>
        <option>Album</option>
      </select>
      <div class="label">Artist Name *</div><input id="artist">
      <div class="label">Full Name *</div><input id="fullname">
      <div class="label">Featuring</div><input id="featuring" placeholder="Optional">
      <div class="label">Label *</div><input id="label">
      <div class="label">Release Date *</div><input type="date" id="release">
    `;
    
        // Set min date = 7 days from now
        setTimeout(() => {
          let r = document.getElementById("release");
          let d = new Date();
          d.setDate(d.getDate() + 7);
          r.min = d.toISOString().split("T")[0];
        }, 50);

      } else if(type.value === "cover") {
        s.innerHTML += `
       <div class="label">Cover Art *</div>
<input id="cover" type="file" accept="image/*">
<img id="coverPreview" style="width:120px;margin:6px 0;display:none;">
<div class="label">Song Title *</div><input id="title">
          <div class="label">Version</div>
          <select id="version">
            <option value="">Pilih</option><option>Remix</option><option>Cover</option>
          </select>
          <div class="label">Genre *</div>
          <select id="genre">
            <option value="">Select</option>
            <option>Blues</option><option>Dangdut</option><option>Electronic</option>
            <option>Hip-hop</option><option>Instrumental</option><option>Jazz</option>
            <option>Metal</option><option>Pop</option><option>R&B</option>
            <option>Reggae</option><option>Rock</option>
          </select>
          <div class="label">Artist Name *</div><input id="artist">
          <div class="label">Featuring</div><input id="featuring" placeholder="Optional">
          <div class="label">Composer *</div><input id="composer">
          <div class="label">Publisher *</div>
          <select id="publisher">
            <option value="">Select</option>
            <option>Nagaswara Official</option>
            <option>G2B Production</option>
            <option>Mahar Pustaka Nusantara</option>
          </select>
        `;
      }

      s.innerHTML += `
        <button type="button" class="btn gray" onclick="back(2)">Back</button><br><br>
        <button type="button" class="btn" onclick="next(2)">Continue</button>
      `;
    }

    // ====== PREVIEW ======
    function loadPreview() {
  const shorten = (text, max=40) => text.length <= max ? text : text.slice(0, max) + "...";
  const audioUrl = document.getElementById("audio").dataset.url;
  const coverUrl = document.getElementById("cover").dataset.url;

  let html = `
    <div><span>Type:</span> ${type.value}</div>
    <div><span>Title:</span> ${title.value}</div>
    <div><span>Artist:</span> ${artist.value}</div>
  `;

  if(document.getElementById("featuring") && featuring.value)
    html += `<div><span>Featuring:</span> ${featuring.value}</div>`;

  html += `
<div><span>Audio:</span> ${audioUrl ? "Uploaded ✔" : "-"}</div>
<div><span>Cover:</span> ${coverUrl ? "Uploaded ✔" : "-"}</div>
  `;

  if(type.value === "original"){
    html += `
      <div><span>Release Type:</span> ${releaseType.value}</div>
      <div><span>Version:</span> ${version.value || "-"}</div>
      <div><span>Full Name:</span> ${fullname.value}</div>
      <div><span>Label:</span> ${label.value}</div>
      <div><span>Release Date:</span> ${release.value}</div>
    `;
  }

  if(type.value === "cover"){
    html += `
      <div><span>Publisher:</span> ${publisher.value}</div>
      <div><span>Composer:</span> ${composer.value}</div>
      <div><span>Version:</span> ${version.value || "-"}</div>
    `;
  }

  previewBox.innerHTML = html;
}
function goto(n){
  hideAll();
  document.getElementById("step"+n).hidden = false;

  for(let i=1;i<=4;i++){
    document.getElementById("s"+i).classList.remove("active");
  }
  document.getElementById("s"+n).classList.add("active");

  if(n === 3){
    attachUploadListeners();
  }
}
    // ====== SUBMIT ======
    function submitRelease() {
      const btn = document.getElementById("submitBtn");
      const text = document.getElementById("btnText");
      const loader = document.getElementById("btnLoader");

      btn.disabled = true;
      text.style.display = "none";
      loader.style.display = "inline";

      const user = firebase.auth().currentUser;
      if(!user) return;

      let data = {
        type: type.value,
        title: title.value,
        artist: artist.value,
        genre: genre.value,
        audio: document.getElementById("audio").dataset.url,
cover: document.getElementById("cover").dataset.url,
        status: "pending",
        time: Date.now()
      };

      if(document.getElementById("featuring") && featuring.value)
        data.featuring = featuring.value;

      if(type.value === "original") {
        data.releaseType = releaseType.value;
        data.version = version.value;
        data.fullname = fullname.value;
        data.label = label.value;
        data.release = release.value;
      }

      if(type.value === "cover") {
        data.publisher = publisher.value;
        data.composer = composer.value;
      }

      db.ref("releases/"+user.uid).push(data)
        .then(()=>{ location.href="../releases"; })
        .catch(()=> {
          btn.disabled = false;
          text.style.display = "inline";
          loader.style.display = "none";
        });
    }

    // ====== SCROLL EFFECT HEADER ======
    window.addEventListener("scroll", ()=>{
      const h = document.getElementById("mainHeader");
      window.scrollY > 5 ? h.classList.add("scrolled") : h.classList.remove("scrolled");
    });
  </script>
</body>
</html>
