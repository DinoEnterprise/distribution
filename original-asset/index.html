<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Original Asset | Dynotic Distribution</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Outfit",sans-serif;}
    body { background:linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; padding-top:72px;}
    header { padding:12px 20px; display:flex; align-items:center; justify-content:space-between; background:#fff; border-bottom:1px solid #eee; position:fixed; top:0; left:0; width:100%; z-index:9999; transition:box-shadow 0.3s;}
    header img { height:42px;}
    header.scrolled { box-shadow:0 4px 12px rgba(0,0,0,0.08);}
    .wrap { width:92%; margin:18px auto; background:rgba(255,255,255,0.95); border-radius:24px; padding:22px; box-shadow:0 20px 40px rgba(0,0,0,0.18); animation:fade 0.4s ease;}
    @keyframes fade { from{opacity:0; transform:translateY(15px);} to{opacity:1;} }
    .steps { display:flex; justify-content:space-between; margin-bottom:25px; position:relative;}
    .steps::before { content:""; position:absolute; top:50%; left:5%; right:5%; height:3px; background:#e5e7eb; z-index:0;}
    .step { width:38px; height:38px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; font-weight:700; color:#666; z-index:1;}
    .step.active { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; box-shadow:0 6px 18px rgba(102,126,234,0.5);}
    .section { animation:fade 0.4s;}
    .label { font-size:13px; font-weight:600; margin-bottom:6px;}
    .req { color:red;}
    input, select { width:100%; padding:14px; border-radius:14px; border:1px solid #ddd; margin-bottom:16px; font-size:14px;}
    input:focus, select:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.15);}
   .upload-box{
  box-shadow:0 8px 20px rgba(102,126,234,0.15);
  display:block;
  width:200px;
  aspect-ratio:1/1;
  border:2px dashed #667eea;
  border-radius:20px;
  cursor:pointer;
  transition:0.3s;
}
.upload-box:hover{
  background:#f3f4ff;
}
.upload-inner{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
.upload-icon{
  font-size:32px;
  font-weight:600;
  color:#667eea;
}
.upload-text{
  font-size:13px;
  color:#667eea;
  margin-top:6px;
}
#coverPreview{
  position:absolute;
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:18px;
  display:none;
}

.upload-audio{
  display:block;
  cursor:pointer;
}
.audio-box{
  display:flex;
  align-items:center;
  gap:14px;
  padding:16px;
  border-radius:18px;
  background:#f9fafb;
  border:1px solid #e5e7eb;
  transition:0.3s;
}
.audio-box:active{
  transform:scale(0.98);
}
.audio-box:hover{
  border-color:#667eea;
  background:#f3f4ff;
}
.audio-icon{
  font-size:22px;
}
.audio-name{
  font-weight:600;
  font-size:14px;
}
.audio-sub{
  font-size:12px;
  color:#888;
}

.progress-wrapper{
  margin-top:14px;
  width:100%;
  height:8px;
  background:#e5e7eb;
  border-radius:6px;
  overflow:hidden;
}
.progress-bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#667eea,#764ba2);
  transition:width 0.3s;
}
    .btn { width:100%; padding:15px; border:none; border-radius:16px; font-weight:700; color:#fff; background:linear-gradient(135deg,#667eea,#764ba2); cursor:pointer;}
    .btn.gray { background:#e5e7eb; color:#111;}
    .btn:active { transform:scale(0.96);}
    .preview { background:#f9fafb; border-radius:16px; padding:16px; font-size:14px; line-height:1.7;}
    .preview div { margin-bottom:8px; }
    .preview span { color:#667eea; font-weight:600; }
  </style>
</head>
<body>
  <header id="mainHeader">
    <img src="../assets/dynotic-distribution.png" alt="DynoPay Logo">
  </header>

  <div class="wrap">
    <!-- STEP PROGRESS -->
    <div class="steps">
      <div class="step active" id="s1">1</div>
      <div class="step" id="s2">2</div>
      <div class="step" id="s3">3</div>
      <div class="step" id="s4">4</div>
    </div>

    <!-- STEP 1 -->
    <div id="step1" class="section">
      <div class="label">Type Asset <span class="req">*</span></div>
      <select id="type" hidden>
        <option value="original" selected>Original Asset</option>
      </select>
      <button type="button" class="btn" onclick="next(1)">Continue</button>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="section" hidden></div>

<!-- STEP 3 -->
<!-- STEP 3 -->
<div id="step3" class="section" hidden>

  <!-- COVER UPLOAD -->
  <div style="margin-bottom:28px;">
    <div class="label" style="margin-bottom:12px;">Cover Art *</div>

    <label class="upload-box">
      <input id="cover" type="file" accept="image/*" hidden>
      <div class="upload-inner">
        <img id="coverPreview" />
        <div id="coverPlaceholder">
          <div class="upload-icon">+</div>
          <div class="upload-text">Upload Cover (JPG / PNG)</div>
        </div>
      </div>
    </label>
  </div>

  <!-- AUDIO UPLOAD -->
  <div style="margin-bottom:28px;">
    <div class="label" style="margin-bottom:12px;">Audio File *</div>

    <label class="upload-audio">
      <input id="audio" type="file" accept="audio/*" hidden>
      <div class="audio-box">
        <div class="audio-icon">ðŸŽµ</div>
        <div class="audio-info">
          <div id="audioName" class="audio-name">No file selected</div>
          <div class="audio-sub">MP3 / WAV</div>
        </div>
      </div>
    </label>

    <div class="progress-wrapper">
      <div id="audioWave" class="progress-bar"></div>
    </div>
  </div>

  <div style="display:flex;gap:12px;">
    <button type="button" class="btn gray" onclick="back(3)" style="flex:1;">Back</button>
    <button type="button" class="btn" id="previewBtn" onclick="loadPreview(); goto(4)" disabled style="flex:2;">Preview</button>
  </div>

</div>

    <!-- STEP 4 -->
    <div id="step4" class="section" hidden>
      <div class="preview" id="previewBox"></div>
      <br>
      <button class="btn gray" onclick="back(4)">Edit</button>
      <br><br>
      <button class="btn" id="submitBtn" onclick="submitRelease()">
        <span id="btnText">Submit Release</span>
        <span id="btnLoader" style="display:none;">Loading...</span>
      </button>
    </div>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase init
    firebase.initializeApp({
      apiKey: "AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
      authDomain: "dynopay-2513c.firebaseapp.com",
      databaseURL: "https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
    });
    const db = firebase.database();

    const WORKER_URL = "https://upload-assets.dynotic-bot.workers.dev/";

    function uploadFile(file, progressCallback, doneCallback){
  const formData = new FormData();
  formData.append("file", file);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", WORKER_URL, true);

  xhr.upload.onprogress = function(e){
    if(e.lengthComputable){
      const percent = Math.round((e.loaded / e.total) * 100);
      progressCallback(percent);
    }
  };

  xhr.onload = function(){
    if(xhr.status === 200){
      const data = JSON.parse(xhr.responseText);
      if(data.success){
        doneCallback(data.url);
      } else {
        alert("Upload gagal: " + data.error);
        doneCallback(null);
      }
    } else {
      alert("Upload gagal!");
      doneCallback(null);
    }
  };

  xhr.onerror = function(){
    alert("Upload error!");
    doneCallback(null);
  };

  xhr.send(formData);
}

    firebase.auth().onAuthStateChanged(user=>{
      if(!user) location.href="../login";
    });

    const stepsData = {
      1: ()=>true,
      2: ()=>{
        return document.getElementById("title")?.value && 
               document.getElementById("artist")?.value &&
               document.getElementById("genre")?.value &&
               document.getElementById("releaseType")?.value &&
               document.getElementById("fullname")?.value &&
               document.getElementById("label")?.value &&
               document.getElementById("release")?.value;
      },
      3: ()=>document.getElementById("audio")?.dataset.url && document.getElementById("cover")?.dataset.url
    };

    function hideAll(){ for(let i=1;i<=4;i++) document.getElementById("step"+i).hidden=true; }

    function loadStep2Fields(){
      const s = document.getElementById("step2");
      s.innerHTML="";
      if(type.value==="original"){
        s.innerHTML += `
          <div class="label">Song Title *</div><input id="title">
          <div class="label">Version</div><input id="version" placeholder="Optional">
          <div class="label">Genre *</div>
          <select id="genre">
            <option value="">Select</option>
            <option>Blues</option><option>Dangdut</option><option>Electronic</option>
            <option>Hip-hop</option><option>Instrumental</option><option>Jazz</option>
            <option>Metal</option><option>Pop</option><option>R&B</option>
            <option>Reggae</option><option>Rock</option>
          </select>
          <div class="label">Release Type *</div>
          <select id="releaseType">
            <option value="">Pilih</option>
            <option>Single</option>
            <option>EP</option>
            <option>Album</option>
          </select>
          <div class="label">Artist Name *</div><input id="artist">
          <div class="label">Full Name *</div><input id="fullname">
          <div class="label">Featuring</div><input id="featuring" placeholder="Optional">
          <div class="label">Label *</div><input id="label">
          <div class="label">Release Date *</div><input type="date" id="release">
        `;
        // set min date 7 hari
        setTimeout(()=>{
          const r = document.getElementById("release");
          let d = new Date(); d.setDate(d.getDate()+7);
          r.min = d.toISOString().split("T")[0];
        },50);
      }
      s.innerHTML += `<button type="button" class="btn gray" onclick="back(2)">Back</button><br><br>
                      <button type="button" class="btn" onclick="next(2)">Continue</button>`;
    }

    // Audio & cover listeners upgraded
let uploadListenerAttached = false;

function attachUploadListeners(){
  if(uploadListenerAttached) return;
  uploadListenerAttached = true;

  const audioInput = document.getElementById("audio");
  const coverInput = document.getElementById("cover");
  const previewBtn = document.getElementById("previewBtn");
  const audioWave = document.getElementById("audioWave");
  const audioName = document.getElementById("audioName");
  const coverPreview = document.getElementById("coverPreview");

  let audioUploaded = false;
  let coverUploaded = false;

  function checkAllUploaded(){
    previewBtn.disabled = !(audioUploaded && coverUploaded);
  }

  // AUDIO LISTENER
  audioInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;

    audioUploaded = false;
    audioName.textContent = file.name;
    audioWave.style.width = "0%";

    uploadFile(
      file,
      percent=>{
        audioWave.style.width = percent + "%";
      },
      url=>{
        if(url){
          audioInput.dataset.url = url;
          audioUploaded = true;
          checkAllUploaded();
        }
      }
    );
  });

  // COVER LISTENER
  coverInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;

    coverUploaded = false;

    const reader = new FileReader();
    reader.onload = ev=>{
      coverPreview.src = ev.target.result;
      coverPreview.style.display = "block";
    };
    reader.readAsDataURL(file);

    uploadFile(
      file,
      percent=>{},
      url=>{
        if(url){
          coverInput.dataset.url = url;
          coverUploaded = true;
          checkAllUploaded();
        }
      }
    );
  });
}

    function next(n){
      if(n===1){
        document.getElementById("type").value="original";
        loadStep2Fields();
        goto(2);
        return;
      }
      if(n===2 && !stepsData[2]()) return alert("Lengkapi master");
      if(n===3){
        const audio=document.getElementById("audio");
        const cover=document.getElementById("cover");
        if(!audio?.dataset.url || !cover?.dataset.url) return alert("Tunggu sampai audio & cover selesai di-upload!");
        loadPreview();
      }
      goto(n+1);
    }

    function back(n){ goto(n-1); }

    function goto(n){
  hideAll();
  document.getElementById("step"+n).hidden=false;

  // ðŸ”¥ TAMBAHAN INI
  if(n === 3){
    attachUploadListeners();
  }

  for(let i=1;i<=4;i++) 
    document.getElementById("s"+i).classList.remove("active");

  document.getElementById("s"+n).classList.add("active");
}

    s1.onclick=()=>goto(1); s2.onclick=()=>goto(2);
    s3.onclick=()=>goto(3); s4.onclick=()=>goto(4);

    function loadPreview(){
      const audioUrl=document.getElementById("audio")?.dataset.url;
      const coverUrl=document.getElementById("cover")?.dataset.url;
      let html=`<div><span>Type:</span> ${type.value}</div>
                <div><span>Title:</span> ${title.value}</div>
                <div><span>Artist:</span> ${artist.value}</div>`;
      if(document.getElementById("featuring")?.value) html+=`<div><span>Featuring:</span> ${featuring.value}</div>`;
      html+=`<div><span>Audio:</span> ${audioUrl?"Uploaded âœ”":"-"}</div>
             <div><span>Cover:</span> ${coverUrl?"Uploaded âœ”":"-"}</div>`;
      html+=`<div><span>Release Type:</span> ${releaseType.value}</div>
             <div><span>Version:</span> ${version.value||"-"}</div>
             <div><span>Full Name:</span> ${fullname.value}</div>
             <div><span>Label:</span> ${label.value}</div>
             <div><span>Release Date:</span> ${release.value}</div>`;
      previewBox.innerHTML=html;
    }

    function submitRelease(){
      const btn=document.getElementById("submitBtn");
      const text=document.getElementById("btnText");
      const loader=document.getElementById("btnLoader");
      btn.disabled=true; text.style.display="none"; loader.style.display="inline";
      const user=firebase.auth().currentUser;
      if(!user) return;
      let data={type:type.value,title:title.value,artist:artist.value,genre:genre.value,audio:audio.dataset.url,cover:cover.dataset.url,status:"pending",time:Date.now()};
      if(featuring?.value) data.featuring=featuring.value;
      data.releaseType=releaseType.value; data.version=version.value; data.fullname=fullname.value; data.label=label.value; data.release=release.value;
      db.ref("releases/"+user.uid).push(data).then(()=>location.href="../releases")
        .catch(()=>{ btn.disabled=false; text.style.display="inline"; loader.style.display="none";});
    }

    window.addEventListener("scroll",()=>{ const h=document.getElementById("mainHeader"); window.scrollY>5?h.classList.add("scrolled"):h.classList.remove("scrolled"); });
  </script>
</body>
</html>
