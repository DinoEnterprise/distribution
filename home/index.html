<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home | Dynotic Distribution</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Global Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Outfit", sans-serif;
    }

    body {
      background: #f1f2f7;
      min-height: 100vh;
      color: #111;
      animation: fadeIn .5s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      padding-top: 74px; /* space for fixed header */
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes bounceIn {
      0% { transform: translateY(-20px); opacity: 0; }
      50% { transform: translateY(10px); opacity: 1; }
      70% { transform: translateY(-5px); }
      100% { transform: translateY(0); opacity: 1; }
    }

    /* Header */
    header {
      padding: 12px 20px;
      display: flex;
      align-items: center;
      background: #fff;
      border-bottom: 1px solid #eee;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    header img {
      height: 50px;
    }

    /* Notification Button */
    .notif-btn {
      margin-left: auto;
      position: relative;
      width: 50px;
      height: 50px;
    }

    .notif-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .notif-badge {
      position: absolute;
      top: -4px;
      right: -6px;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      display: none;
    }

    /* Message Popup */
    .message-popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .message-popup.show { display: flex; }

    .message-card {
      width: 85%;
      max-width: 340px;
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      animation: bounceIn .4s ease;
    }

    .message-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
    }

    .message-text {
      font-size: 13px;
      color: #555;
      line-height: 1.4;
    }

    .message-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 14px;
    }

    .view-btn {
      background: #667eea;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
    }

    .close-btn {
      background: #eee;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    /* Cards */
    .card {
      width: 90%;
      margin: 35px auto;
      background: #fff;
      border-radius: 20px;
      padding: 25px;
      border: 1px solid #ececec;
      box-shadow: 0 8px 18px rgba(0,0,0,.05);
      transition: .3s;
      animation: bounceIn .6s ease;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
    }

    .artist-name {
      font-size: 15px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }

    .balance-title {
      font-size: 15px;
      font-weight: 600;
      color: #222;
      margin-bottom: 10px;
    }

    .card-value {
      font-size: 33px;
      font-weight: 700;
      color: #111;
      margin-bottom: 15px;
    }

    /* Profile Menu */
    .profile-menu {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
      display: none;
      width: 180px;
      z-index: 10;
      opacity: 0;
      transform: translateY(20px);
      transition: .25s ease;
    }

    .profile-menu.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .profile-menu div {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .profile-menu div:last-child { border-bottom: none; }
    .profile-menu div:hover { background: #f1f2f7; }

    /* Clickable */
    .clickable {
      cursor: pointer;
      transition: .12s;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }

    .clickable:active {
      transform: scale(.94);
      filter: brightness(85%);
      box-shadow: inset 0 2px 6px rgba(0,0,0,.2);
    }

    /* Bottom Navigation */
    .bottom-nav {
      background: #fff;
      border-top: 1px solid #eee;
      padding: 10px 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
    }

    .nav-item {
      text-align: center;
      font-size: 13px;
      opacity: .75;
      padding: 4px 14px;
      border-radius: 12px;
    }

    .nav-item img {
      width: 28px;
      display: block;
      margin: auto auto 4px;
    }

    .nav-item:hover { opacity: 1; }
    .nav-item.active { opacity: 1; color: #667eea; }
    .nav-item.active img { filter: brightness(1.2); }

    /* Buttons */
    button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(90deg, #667eea, #764ba2);
      cursor: pointer;
    }

    button:hover { filter: brightness(90%); }
    button:active {
      filter: brightness(70%);
      transform: scale(.95);
    }

    /* Release Row */
    .release-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }

    .release-title { max-width: 75%; line-height: 1.3; }
    .release-status { white-space: nowrap; flex-shrink: 0; }

  </style>
</head>

<body>

  <!-- Header -->
  <header>
    <img src="../assets/dynotic-distribution.png">
    <div id="notifBtn" class="notif-btn clickable" onclick="openMessages()">
      <img src="../assets/message.png">
      <span id="notifBadge" class="notif-badge">0</span>
    </div>
  </header>

  <!-- Message Popup -->
  <div id="messagePopup" class="message-popup">
    <div class="message-card">
      <div class="message-title" id="msgTitle"></div>
      <div class="message-text" id="msgText"></div>
      <div class="message-actions">
        <button class="view-btn" onclick="viewMessage()">View</button>
        <button class="close-btn" onclick="closeMessage()">✕</button>
      </div>
    </div>
  </div>

  <!-- Main Wallet -->
  <div class="card clickable" onclick="goRekapan()">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="namaArtis" class="artist-name">Hi, --</div>
        <div class="balance-title">Main Wallet Balance</div>
        <div id="saldo" class="card-value">Rp 0</div>
      </div>
      <div style="width:48px;height:48px;border-radius:14px;background:#111;display:flex;align-items:center;justify-content:center;">
        <img src="../assets/history.png" style="width:26px">
      </div>
    </div>
  </div>

  <!-- Latest Releases -->
  <div class="card">
    <div style="font-weight:700;font-size:16px;margin-bottom:12px">Latest Releases</div>
    <div id="releaseList"></div>
  </div>

  <div style="height:120px"></div>

  <!-- Profile Menu -->
  <div id="profileMenu" class="profile-menu">
    <div class="clickable" onclick="goAccount()">Account</div>
    <div class="clickable" onclick="logout()">Log Out</div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item clickable active" onclick="homeClick()">
      <img src="../assets/home.png"> Home
    </div>
    <div class="nav-item clickable" onclick="goReleases()">
      <img src="../assets/releases.png"> Releases
    </div>
    <div class="nav-item clickable" onclick="accountClick()">
      <img src="../assets/account.png"> Account
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBRSkmZXbTPNupefSmjXvlKLDNsaeQ2zag",
      authDomain: "dynopay-2513c.firebaseapp.com",
      databaseURL: "https://dynopay-2513c-default-rtdb.asia-southeast1.firebasedatabase.app"
    });

    const db = firebase.database();
    let targetSaldo = 0;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) location.href = "../login";
      else {
        loadReleases(user.uid);
        loadMessages(user.uid);

        db.ref("users/" + user.uid).once("value").then(snap => {
          if (snap.exists()) {
            const d = snap.val();
            targetSaldo = Number(d.saldo || 0);
            namaArtis.textContent = "Hi, " + (d.nama || "Artist");
            animateSaldo();
          }
        });
      }
    });

    function animateSaldo() {
      let angka = 0;
      const step = Math.ceil(targetSaldo / 15);
      const i = setInterval(() => {
        if (angka < targetSaldo) {
          angka += step;
          if (angka > targetSaldo) angka = targetSaldo;
          saldo.textContent = "Rp " + angka.toLocaleString("id-ID");
        } else clearInterval(i);
      }, 15);
    }

    function logout() { firebase.auth().signOut().then(() => location.href="../login"); }
    function goReleases() { location.href = "../releases"; }
    function accountClick() { location.href = "../account"; }
    function toggleProfileMenu() { profileMenu.classList.toggle("show"); }
    function homeClick() { console.log("Dashboard active — tidak reload"); }
    function goRekapan() { location.href = "../income"; }

    /* Load Latest Releases */
    const previewLimit = 3;
    function loadReleases(uid) {
      const releaseList = document.getElementById("releaseList");
      releaseList.innerHTML = "<div style='color:#888;font-size:13px'>Loading...</div>";

      db.ref("releases/" + uid).once("value").then(snap => {
        const all = [];
        snap.forEach(i => { const r = i.val(); r._key = i.key; all.push(r); });
        all.sort((a,b)=> (b.time||0)-(a.time||0));
        releaseList.innerHTML = "";
        if(all.length===0){ releaseList.innerHTML="<div style='text-align:center;color:#888;font-size:13px'>No releases yet</div>"; return; }

        all.slice(0, previewLimit).forEach(r=>{
          let c="#f59e0b"; if(r.status=="approved")c="#10b981"; if(r.status=="rejected")c="#ef4444";
          releaseList.innerHTML += `
            <div onclick="goReleaseDetail('${r._key}')" class="clickable" style="padding:12px;border:1px solid #eee;border-radius:12px;margin-bottom:10px">
              <div class="release-row">
                <div class="release-title" style="font-weight:600">${r.title||"-"}</div>
                <div class="release-status" style="font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid ${c};color:${c}">
                  ${(r.status||"pending").toUpperCase()}
                </div>
              </div>
              <div style="font-size:12px;color:#777;margin-top:4px">
                ${r.artist||"-"} • ${r.genre||"-"}
              </div>
            </div>`;
        });
      });
    }

    function goReleaseDetail(rid) { location.href = "../release-detail?rid=" + rid; }

    /* Messages */
    let messagesQueue=[], currentMsgIndex=0;

    function loadMessages(uid){
      db.ref("messages_inbox/"+uid).on("value", snap=>{
        messagesQueue=[];
        snap.forEach(i=>{ const m=i.val(); if(!m.read) messagesQueue.push({...m,key:i.key}); });
        notifBadge.style.display=messagesQueue.length>0?"block":"none";
        if(messagesQueue.length>0) notifBadge.textContent=messagesQueue.length;
      });
    }

    function openMessages(){ if(messagesQueue.length===0) return; currentMsgIndex=0; showCurrentMessage(); }
    function showCurrentMessage(){
      if(currentMsgIndex>=messagesQueue.length){ messagePopup.classList.remove("show"); return; }
      const m=messagesQueue[currentMsgIndex];
      msgTitle.textContent=m.subject||"-";
      msgText.textContent=m.body||"-";
      messagePopup.classList.add("show");
    }
    function closeMessage(){
      const m=messagesQueue[currentMsgIndex];
      if(m) db.ref("messages_inbox/"+firebase.auth().currentUser.uid+"/"+m.key+"/read").set(true);
      currentMsgIndex++; showCurrentMessage();
    }
    function viewMessage(){ const m=messagesQueue[currentMsgIndex]; db.ref("messages_inbox/"+firebase.auth().currentUser.uid+"/"+m.key+"/read").set(true); closeMessage(); }
  </script>

</body>
</html>
